(function(self){"use strict";if(self.fetch){return}var support={searchParams:"URLSearchParams"in self,iterable:"Symbol"in self&&"iterator"in Symbol,blob:"FileReader"in self&&"Blob"in self&&function(){try{new Blob;return true}catch(e){return false}}(),formData:"FormData"in self,arrayBuffer:"ArrayBuffer"in self};if(support.arrayBuffer){var viewClasses=["[object Int8Array]","[object Uint8Array]","[object Uint8ClampedArray]","[object Int16Array]","[object Uint16Array]","[object Int32Array]","[object Uint32Array]","[object Float32Array]","[object Float64Array]"];var isDataView=function(obj){return obj&&DataView.prototype.isPrototypeOf(obj)};var isArrayBufferView=ArrayBuffer.isView||function(obj){return obj&&viewClasses.indexOf(Object.prototype.toString.call(obj))>-1}}function normalizeName(name){if(typeof name!=="string"){name=String(name)}if(/[^a-z0-9\-#$%&'*+.\^_`|~]/i.test(name)){throw new TypeError("Invalid character in header field name")}return name.toLowerCase()}function normalizeValue(value){if(typeof value!=="string"){value=String(value)}return value}function iteratorFor(items){var iterator={next:function(){var value=items.shift();return{done:value===undefined,value:value}}};if(support.iterable){iterator[Symbol.iterator]=function(){return iterator}}return iterator}function Headers(headers){this.map={};if(headers instanceof Headers){headers.forEach(function(value,name){this.append(name,value)},this)}else if(Array.isArray(headers)){headers.forEach(function(header){this.append(header[0],header[1])},this)}else if(headers){Object.getOwnPropertyNames(headers).forEach(function(name){this.append(name,headers[name])},this)}}Headers.prototype.append=function(name,value){name=normalizeName(name);value=normalizeValue(value);var oldValue=this.map[name];this.map[name]=oldValue?oldValue+","+value:value};Headers.prototype["delete"]=function(name){delete this.map[normalizeName(name)]};Headers.prototype.get=function(name){name=normalizeName(name);return this.has(name)?this.map[name]:null};Headers.prototype.has=function(name){return this.map.hasOwnProperty(normalizeName(name))};Headers.prototype.set=function(name,value){this.map[normalizeName(name)]=normalizeValue(value)};Headers.prototype.forEach=function(callback,thisArg){for(var name in this.map){if(this.map.hasOwnProperty(name)){callback.call(thisArg,this.map[name],name,this)}}};Headers.prototype.keys=function(){var items=[];this.forEach(function(value,name){items.push(name)});return iteratorFor(items)};Headers.prototype.values=function(){var items=[];this.forEach(function(value){items.push(value)});return iteratorFor(items)};Headers.prototype.entries=function(){var items=[];this.forEach(function(value,name){items.push([name,value])});return iteratorFor(items)};if(support.iterable){Headers.prototype[Symbol.iterator]=Headers.prototype.entries}function consumed(body){if(body.bodyUsed){return Promise.reject(new TypeError("Already read"))}body.bodyUsed=true}function fileReaderReady(reader){return new Promise(function(resolve,reject){reader.onload=function(){resolve(reader.result)};reader.onerror=function(){reject(reader.error)}})}function readBlobAsArrayBuffer(blob){var reader=new FileReader;var promise=fileReaderReady(reader);reader.readAsArrayBuffer(blob);return promise}function readBlobAsText(blob){var reader=new FileReader;var promise=fileReaderReady(reader);reader.readAsText(blob);return promise}function readArrayBufferAsText(buf){var view=new Uint8Array(buf);var chars=new Array(view.length);for(var i=0;i<view.length;i++){chars[i]=String.fromCharCode(view[i])}return chars.join("")}function bufferClone(buf){if(buf.slice){return buf.slice(0)}else{var view=new Uint8Array(buf.byteLength);view.set(new Uint8Array(buf));return view.buffer}}function Body(){this.bodyUsed=false;this._initBody=function(body){this._bodyInit=body;if(!body){this._bodyText=""}else if(typeof body==="string"){this._bodyText=body}else if(support.blob&&Blob.prototype.isPrototypeOf(body)){this._bodyBlob=body}else if(support.formData&&FormData.prototype.isPrototypeOf(body)){this._bodyFormData=body}else if(support.searchParams&&URLSearchParams.prototype.isPrototypeOf(body)){this._bodyText=body.toString()}else if(support.arrayBuffer&&support.blob&&isDataView(body)){this._bodyArrayBuffer=bufferClone(body.buffer);this._bodyInit=new Blob([this._bodyArrayBuffer])}else if(support.arrayBuffer&&(ArrayBuffer.prototype.isPrototypeOf(body)||isArrayBufferView(body))){this._bodyArrayBuffer=bufferClone(body)}else{throw new Error("unsupported BodyInit type")}if(!this.headers.get("content-type")){if(typeof body==="string"){this.headers.set("content-type","text/plain;charset=UTF-8")}else if(this._bodyBlob&&this._bodyBlob.type){this.headers.set("content-type",this._bodyBlob.type)}else if(support.searchParams&&URLSearchParams.prototype.isPrototypeOf(body)){this.headers.set("content-type","application/x-www-form-urlencoded;charset=UTF-8")}}};if(support.blob){this.blob=function(){var rejected=consumed(this);if(rejected){return rejected}if(this._bodyBlob){return Promise.resolve(this._bodyBlob)}else if(this._bodyArrayBuffer){return Promise.resolve(new Blob([this._bodyArrayBuffer]))}else if(this._bodyFormData){throw new Error("could not read FormData body as blob")}else{return Promise.resolve(new Blob([this._bodyText]))}};this.arrayBuffer=function(){if(this._bodyArrayBuffer){return consumed(this)||Promise.resolve(this._bodyArrayBuffer)}else{return this.blob().then(readBlobAsArrayBuffer)}}}this.text=function(){var rejected=consumed(this);if(rejected){return rejected}if(this._bodyBlob){return readBlobAsText(this._bodyBlob)}else if(this._bodyArrayBuffer){return Promise.resolve(readArrayBufferAsText(this._bodyArrayBuffer))}else if(this._bodyFormData){throw new Error("could not read FormData body as text")}else{return Promise.resolve(this._bodyText)}};if(support.formData){this.formData=function(){return this.text().then(decode)}}this.json=function(){return this.text().then(JSON.parse)};return this}var methods=["DELETE","GET","HEAD","OPTIONS","POST","PUT"];function normalizeMethod(method){var upcased=method.toUpperCase();return methods.indexOf(upcased)>-1?upcased:method}function Request(input,options){options=options||{};var body=options.body;if(input instanceof Request){if(input.bodyUsed){throw new TypeError("Already read")}this.url=input.url;this.credentials=input.credentials;if(!options.headers){this.headers=new Headers(input.headers)}this.method=input.method;this.mode=input.mode;if(!body&&input._bodyInit!=null){body=input._bodyInit;input.bodyUsed=true}}else{this.url=String(input)}this.credentials=options.credentials||this.credentials||"omit";if(options.headers||!this.headers){this.headers=new Headers(options.headers)}this.method=normalizeMethod(options.method||this.method||"GET");this.mode=options.mode||this.mode||null;this.referrer=null;if((this.method==="GET"||this.method==="HEAD")&&body){throw new TypeError("Body not allowed for GET or HEAD requests")}this._initBody(body)}Request.prototype.clone=function(){return new Request(this,{body:this._bodyInit})};function decode(body){var form=new FormData;body.trim().split("&").forEach(function(bytes){if(bytes){var split=bytes.split("=");var name=split.shift().replace(/\+/g," ");var value=split.join("=").replace(/\+/g," ");form.append(decodeURIComponent(name),decodeURIComponent(value))}});return form}function parseHeaders(rawHeaders){var headers=new Headers;var preProcessedHeaders=rawHeaders.replace(/\r?\n[\t ]+/g," ");preProcessedHeaders.split(/\r?\n/).forEach(function(line){var parts=line.split(":");var key=parts.shift().trim();if(key){var value=parts.join(":").trim();headers.append(key,value)}});return headers}Body.call(Request.prototype);function Response(bodyInit,options){if(!options){options={}}this.type="default";this.status="status"in options?options.status:200;this.ok=this.status>=200&&this.status<300;this.statusText="statusText"in options?options.statusText:"OK";this.headers=new Headers(options.headers);this.url=options.url||"";this._initBody(bodyInit)}Body.call(Response.prototype);Response.prototype.clone=function(){return new Response(this._bodyInit,{status:this.status,statusText:this.statusText,headers:new Headers(this.headers),url:this.url})};Response.error=function(){var response=new Response(null,{status:0,statusText:""});response.type="error";return response};var redirectStatuses=[301,302,303,307,308];Response.redirect=function(url,status){if(redirectStatuses.indexOf(status)===-1){throw new RangeError("Invalid status code")}return new Response(null,{status:status,headers:{location:url}})};self.Headers=Headers;self.Request=Request;self.Response=Response;self.fetch=function(input,init){return new Promise(function(resolve,reject){var request=new Request(input,init);var xhr=new XMLHttpRequest;xhr.onload=function(){var options={status:xhr.status,statusText:xhr.statusText,headers:parseHeaders(xhr.getAllResponseHeaders()||"")};options.url="responseURL"in xhr?xhr.responseURL:options.headers.get("X-Request-URL");var body="response"in xhr?xhr.response:xhr.responseText;resolve(new Response(body,options))};xhr.onerror=function(){reject(new TypeError("Network request failed"))};xhr.ontimeout=function(){reject(new TypeError("Network request failed"))};xhr.open(request.method,request.url,true);if(request.credentials==="include"){xhr.withCredentials=true}else if(request.credentials==="omit"){xhr.withCredentials=false}if("responseType"in xhr&&support.blob){xhr.responseType="blob"}request.headers.forEach(function(value,name){xhr.setRequestHeader(name,value)});xhr.send(typeof request._bodyInit==="undefined"?null:request._bodyInit)})};self.fetch.polyfill=true})(typeof self!=="undefined"?self:this);(function(global){"use strict";var setTimeout=global.setTimeout;var clearTimeout=global.clearTimeout;var k=function(){};function XHRTransport(xhr,onStartCallback,onProgressCallback,onFinishCallback,thisArg){this._internal=new XHRTransportInternal(xhr,onStartCallback,onProgressCallback,onFinishCallback,thisArg)}XHRTransport.prototype.open=function(url,withCredentials){this._internal.open(url,withCredentials)};XHRTransport.prototype.cancel=function(){this._internal.cancel()};function XHRTransportInternal(xhr,onStartCallback,onProgressCallback,onFinishCallback,thisArg){this.onStartCallback=onStartCallback;this.onProgressCallback=onProgressCallback;this.onFinishCallback=onFinishCallback;this.thisArg=thisArg;this.xhr=xhr;this.state=0;this.charOffset=0;this.offset=0;this.url="";this.withCredentials=false;this.timeout=0}XHRTransportInternal.prototype.onStart=function(){if(this.state===1){this.state=2;var status=0;var statusText="";var contentType=undefined;if(!("contentType"in this.xhr)){try{status=this.xhr.status;statusText=this.xhr.statusText;contentType=this.xhr.getResponseHeader("Content-Type")}catch(error){status=0;statusText="";contentType=undefined}}else{status=200;statusText="OK";contentType=this.xhr.contentType}if(contentType==undefined){contentType=""}this.onStartCallback.call(this.thisArg,status,statusText,contentType)}};XHRTransportInternal.prototype.onProgress=function(){this.onStart();if(this.state===2||this.state===3){this.state=3;var responseText="";try{responseText=this.xhr.responseText}catch(error){}var chunkStart=this.charOffset;var length=responseText.length;for(var i=this.offset;i<length;i+=1){var c=responseText.charCodeAt(i);if(c==="\n".charCodeAt(0)||c==="\r".charCodeAt(0)){this.charOffset=i+1}}this.offset=length;var chunk=responseText.slice(chunkStart,this.charOffset);this.onProgressCallback.call(this.thisArg,chunk)}};XHRTransportInternal.prototype.onFinish=function(){this.onProgress();if(this.state===3){this.state=4;if(this.timeout!==0){clearTimeout(this.timeout);this.timeout=0}this.onFinishCallback.call(this.thisArg)}};XHRTransportInternal.prototype.onReadyStateChange=function(){if(this.xhr!=undefined){if(this.xhr.readyState===4){if(this.xhr.status===0){this.onFinish()}else{this.onFinish()}}else if(this.xhr.readyState===3){this.onProgress()}else if(this.xhr.readyState===2){}}};XHRTransportInternal.prototype.onTimeout2=function(){this.timeout=0;var tmp=/^data\:([^,]*?)(base64)?,([\S]*)$/.exec(this.url);var contentType=tmp[1];var data=tmp[2]==="base64"?global.atob(tmp[3]):decodeURIComponent(tmp[3]);if(this.state===1){this.state=2;this.onStartCallback.call(this.thisArg,200,"OK",contentType)}if(this.state===2||this.state===3){this.state=3;this.onProgressCallback.call(this.thisArg,data)}if(this.state===3){this.state=4;this.onFinishCallback.call(this.thisArg)}};XHRTransportInternal.prototype.onTimeout1=function(){this.timeout=0;this.open(this.url,this.withCredentials)};XHRTransportInternal.prototype.onTimeout0=function(){var that=this;this.timeout=setTimeout(function(){that.onTimeout0()},500);if(this.xhr.readyState===3){this.onProgress()}};XHRTransportInternal.prototype.handleEvent=function(event){if(event.type==="load"){this.onFinish()}else if(event.type==="error"){this.onFinish()}else if(event.type==="abort"){this.onFinish()}else if(event.type==="progress"){this.onProgress()}else if(event.type==="readystatechange"){this.onReadyStateChange()}};XHRTransportInternal.prototype.open=function(url,withCredentials){if(this.timeout!==0){clearTimeout(this.timeout);this.timeout=0}this.url=url;this.withCredentials=withCredentials;this.state=1;this.charOffset=0;this.offset=0;var that=this;var tmp=/^data\:([^,]*?)(?:;base64)?,[\S]*$/.exec(url);if(tmp!=undefined){this.timeout=setTimeout(function(){that.onTimeout2()},0);return}if((!("ontimeout"in this.xhr)||"sendAsBinary"in this.xhr||"mozAnon"in this.xhr)&&global.document!=undefined&&global.document.readyState!=undefined&&global.document.readyState!=="complete"){this.timeout=setTimeout(function(){that.onTimeout1()},4);return}this.xhr.onload=function(event){that.handleEvent({type:"load"})};this.xhr.onerror=function(){that.handleEvent({type:"error"})};this.xhr.onabort=function(){that.handleEvent({type:"abort"})};this.xhr.onprogress=function(){that.handleEvent({type:"progress"})};this.xhr.onreadystatechange=function(){that.handleEvent({type:"readystatechange"})};this.xhr.open("GET",url,true);this.xhr.withCredentials=withCredentials;this.xhr.responseType="text";if("setRequestHeader"in this.xhr){this.xhr.setRequestHeader("Accept","text/event-stream")}try{this.xhr.send(undefined)}catch(error1){throw error1}if("readyState"in this.xhr&&global.opera!=undefined){this.timeout=setTimeout(function(){that.onTimeout0()},0)}};XHRTransportInternal.prototype.cancel=function(){if(this.state!==0&&this.state!==4){this.state=4;this.xhr.onload=k;this.xhr.onerror=k;this.xhr.onabort=k;this.xhr.onprogress=k;this.xhr.onreadystatechange=k;this.xhr.abort();if(this.timeout!==0){clearTimeout(this.timeout);this.timeout=0}this.onFinishCallback.call(this.thisArg)}this.state=0};function Map(){this._data={}}Map.prototype.get=function(key){return this._data[key+"~"]};Map.prototype.set=function(key,value){this._data[key+"~"]=value};Map.prototype["delete"]=function(key){delete this._data[key+"~"]};function EventTarget(){this._listeners=new Map}function throwError(e){setTimeout(function(){throw e},0)}EventTarget.prototype.dispatchEvent=function(event){event.target=this;var type=event.type.toString();var listeners=this._listeners;var typeListeners=listeners.get(type);if(typeListeners==undefined){return}var length=typeListeners.length;var listener=undefined;for(var i=0;i<length;i+=1){listener=typeListeners[i];try{if(typeof listener.handleEvent==="function"){listener.handleEvent(event)}else{listener.call(this,event)}}catch(e){throwError(e)}}};EventTarget.prototype.addEventListener=function(type,callback){type=type.toString();var listeners=this._listeners;var typeListeners=listeners.get(type);if(typeListeners==undefined){typeListeners=[];listeners.set(type,typeListeners)}for(var i=typeListeners.length;i>=0;i-=1){if(typeListeners[i]===callback){return}}typeListeners.push(callback)};EventTarget.prototype.removeEventListener=function(type,callback){type=type.toString();var listeners=this._listeners;var typeListeners=listeners.get(type);if(typeListeners==undefined){return}var length=typeListeners.length;var filtered=[];for(var i=0;i<length;i+=1){if(typeListeners[i]!==callback){filtered.push(typeListeners[i])}}if(filtered.length===0){listeners["delete"](type)}else{listeners.set(type,filtered)}};function Event(type){this.type=type;this.target=undefined}function MessageEvent(type,options){Event.call(this,type);this.data=options.data;this.lastEventId=options.lastEventId}MessageEvent.prototype=Event.prototype;var XHR=global.XMLHttpRequest;var XDR=global.XDomainRequest;var isCORSSupported=XHR!=undefined&&(new XHR).withCredentials!=undefined;var Transport=isCORSSupported||XHR!=undefined&&XDR==undefined?XHR:XDR;var WAITING=-1;var CONNECTING=0;var OPEN=1;var CLOSED=2;var AFTER_CR=3;var FIELD_START=4;var FIELD=5;var VALUE_START=6;var VALUE=7;var contentTypeRegExp=/^text\/event\-stream;?(\s*charset\=utf\-8)?$/i;var MINIMUM_DURATION=1e3;var MAXIMUM_DURATION=18e6;var getDuration=function(value,def){var n=value;if(n!==n){n=def}return n<MINIMUM_DURATION?MINIMUM_DURATION:n>MAXIMUM_DURATION?MAXIMUM_DURATION:n};var fire=function(that,f,event){try{if(typeof f==="function"){f.call(that,event)}}catch(e){throwError(e)}};function EventSource(url,options){EventTarget.call(this);this.onopen=undefined;this.onmessage=undefined;this.onerror=undefined;this.url="";this.readyState=CONNECTING;this.withCredentials=false;this._internal=new EventSourceInternal(this,url,options)}function EventSourceInternal(es,url,options){this.url=url.toString();this.readyState=CONNECTING;this.withCredentials=isCORSSupported&&options!=undefined&&Boolean(options.withCredentials);this.es=es;this.initialRetry=getDuration(1e3,0);this.heartbeatTimeout=getDuration(45e3,0);this.lastEventId="";this.retry=this.initialRetry;this.wasActivity=false;var CurrentTransport=options!=undefined&&options.Transport!=undefined?options.Transport:Transport;var xhr=new CurrentTransport;this.transport=new XHRTransport(xhr,this.onStart,this.onProgress,this.onFinish,this);this.timeout=0;this.currentState=WAITING;this.dataBuffer=[];this.lastEventIdBuffer="";this.eventTypeBuffer="";this.state=FIELD_START;this.fieldStart=0;this.valueStart=0;this.es.url=this.url;this.es.readyState=this.readyState;this.es.withCredentials=this.withCredentials;this.onTimeout()}EventSourceInternal.prototype.onStart=function(status,statusText,contentType){if(this.currentState===CONNECTING){if(contentType==undefined){contentType=""}if(status===200&&contentTypeRegExp.test(contentType)){this.currentState=OPEN;this.wasActivity=true;this.retry=this.initialRetry;this.readyState=OPEN;this.es.readyState=OPEN;var event=new Event("open");this.es.dispatchEvent(event);fire(this.es,this.es.onopen,event)}else if(status!==0){var message="";if(status!==200){message="EventSource's response has a status "+status+" "+statusText.replace(/\s+/g," ")+" that is not 200. Aborting the connection."}else{message="EventSource's response has a Content-Type specifying an unsupported type: "+contentType.replace(/\s+/g," ")+". Aborting the connection."}throwError(new Error(message));this.close();var event=new Event("error");this.es.dispatchEvent(event);fire(this.es,this.es.onerror,event)}}};EventSourceInternal.prototype.onProgress=function(chunk){if(this.currentState===OPEN){var length=chunk.length;if(length!==0){this.wasActivity=true}for(var position=0;position<length;position+=1){var c=chunk.charCodeAt(position);if(this.state===AFTER_CR&&c==="\n".charCodeAt(0)){this.state=FIELD_START}else{if(this.state===AFTER_CR){this.state=FIELD_START}if(c==="\r".charCodeAt(0)||c==="\n".charCodeAt(0)){if(this.state!==FIELD_START){if(this.state===FIELD){this.valueStart=position+1}var field=chunk.slice(this.fieldStart,this.valueStart-1);var value=chunk.slice(this.valueStart+(this.valueStart<position&&chunk.charCodeAt(this.valueStart)===" ".charCodeAt(0)?1:0),position);if(field==="data"){this.dataBuffer.push(value)}else if(field==="id"){this.lastEventIdBuffer=value}else if(field==="event"){this.eventTypeBuffer=value}else if(field==="retry"){this.initialRetry=getDuration(Number(value),this.initialRetry);this.retry=this.initialRetry}else if(field==="heartbeatTimeout"){this.heartbeatTimeout=getDuration(Number(value),this.heartbeatTimeout);if(this.timeout!==0){clearTimeout(this.timeout);var that=this;this.timeout=setTimeout(function(){that.onTimeout()},this.heartbeatTimeout)}}}if(this.state===FIELD_START){if(this.dataBuffer.length!==0){this.lastEventId=this.lastEventIdBuffer;if(this.eventTypeBuffer===""){this.eventTypeBuffer="message"}var event=new MessageEvent(this.eventTypeBuffer,{data:this.dataBuffer.join("\n"),lastEventId:this.lastEventIdBuffer});this.es.dispatchEvent(event);if(this.eventTypeBuffer==="message"){fire(this.es,this.es.onmessage,event)}if(this.currentState===CLOSED){return}}this.dataBuffer.length=0;this.eventTypeBuffer=""}this.state=c==="\r".charCodeAt(0)?AFTER_CR:FIELD_START}else{if(this.state===FIELD_START){this.fieldStart=position;this.state=FIELD}if(this.state===FIELD){if(c===":".charCodeAt(0)){this.valueStart=position+1;this.state=VALUE_START}}else if(this.state===VALUE_START){this.state=VALUE}}}}}};EventSourceInternal.prototype.onFinish=function(){if(this.currentState===OPEN||this.currentState===CONNECTING){this.currentState=WAITING;if(this.timeout!==0){clearTimeout(this.timeout);this.timeout=0}if(this.retry>this.initialRetry*16){this.retry=this.initialRetry*16}if(this.retry>MAXIMUM_DURATION){this.retry=MAXIMUM_DURATION}var that=this;this.timeout=setTimeout(function(){that.onTimeout()},this.retry);this.retry=this.retry*2+1;this.readyState=CONNECTING;this.es.readyState=CONNECTING;var event=new Event("error");this.es.dispatchEvent(event);fire(this.es,this.es.onerror,event)}};EventSourceInternal.prototype.onTimeout=function(){this.timeout=0;if(this.currentState!==WAITING){if(!this.wasActivity){throwError(new Error("No activity within "+this.heartbeatTimeout+" milliseconds. Reconnecting."));this.transport.cancel()}else{this.wasActivity=false;var that=this;this.timeout=setTimeout(function(){that.onTimeout()},this.heartbeatTimeout)}return}this.wasActivity=false;var that=this;this.timeout=setTimeout(function(){that.onTimeout()},this.heartbeatTimeout);this.currentState=CONNECTING;this.dataBuffer.length=0;this.eventTypeBuffer="";this.lastEventIdBuffer=this.lastEventId;this.fieldStart=0;this.valueStart=0;this.state=FIELD_START;var s=this.url.slice(0,5);if(s!=="data:"&&s!=="blob:"){s=this.url+((this.url.indexOf("?",0)===-1?"?":"&")+"lastEventId="+encodeURIComponent(this.lastEventId)+"&r="+(Math.random()+1).toString().slice(2))}else{s=this.url}try{this.transport.open(s,this.withCredentials)}catch(error){this.close();throw error}};EventSourceInternal.prototype.close=function(){this.currentState=CLOSED;this.transport.cancel();if(this.timeout!==0){clearTimeout(this.timeout);this.timeout=0}this.readyState=CLOSED;this.es.readyState=CLOSED};function F(){this.CONNECTING=CONNECTING;this.OPEN=OPEN;this.CLOSED=CLOSED}F.prototype=EventTarget.prototype;EventSource.prototype=new F;EventSource.prototype.close=function(){this._internal.close()};F.call(EventSource);if(isCORSSupported){EventSource.prototype.withCredentials=undefined}var isEventSourceSupported=function(){return global.EventSource!=undefined&&"withCredentials"in global.EventSource.prototype};if(Transport!=undefined&&(global.EventSource==undefined||isCORSSupported&&!isEventSourceSupported())){global.NativeEventSource=global.EventSource;global.EventSource=EventSource}})(typeof window!=="undefined"?window:this);(function(root){var setTimeoutFunc=setTimeout;function noop(){}function bind(fn,thisArg){return function(){fn.apply(thisArg,arguments)}}function Promise(fn){if(typeof this!=="object")throw new TypeError("Promises must be constructed via new");if(typeof fn!=="function")throw new TypeError("not a function");this._state=0;this._handled=false;this._value=undefined;this._deferreds=[];doResolve(fn,this)}function handle(self,deferred){while(self._state===3){self=self._value}if(self._state===0){self._deferreds.push(deferred);return}self._handled=true;Promise._immediateFn(function(){var cb=self._state===1?deferred.onFulfilled:deferred.onRejected;if(cb===null){(self._state===1?resolve:reject)(deferred.promise,self._value);return}var ret;try{ret=cb(self._value)}catch(e){reject(deferred.promise,e);return}resolve(deferred.promise,ret)})}function resolve(self,newValue){try{if(newValue===self)throw new TypeError("A promise cannot be resolved with itself.");if(newValue&&(typeof newValue==="object"||typeof newValue==="function")){var then=newValue.then;if(newValue instanceof Promise){self._state=3;self._value=newValue;finale(self);return}else if(typeof then==="function"){doResolve(bind(then,newValue),self);return}}self._state=1;self._value=newValue;finale(self)}catch(e){reject(self,e)}}function reject(self,newValue){self._state=2;self._value=newValue;finale(self)}function finale(self){if(self._state===2&&self._deferreds.length===0){Promise._immediateFn(function(){if(!self._handled){Promise._unhandledRejectionFn(self._value)}})}for(var i=0,len=self._deferreds.length;i<len;i++){handle(self,self._deferreds[i])}self._deferreds=null}function Handler(onFulfilled,onRejected,promise){this.onFulfilled=typeof onFulfilled==="function"?onFulfilled:null;this.onRejected=typeof onRejected==="function"?onRejected:null;this.promise=promise}function doResolve(fn,self){var done=false;try{fn(function(value){if(done)return;done=true;resolve(self,value)},function(reason){if(done)return;done=true;reject(self,reason)})}catch(ex){if(done)return;done=true;reject(self,ex)}}Promise.prototype["catch"]=function(onRejected){return this.then(null,onRejected)};Promise.prototype.then=function(onFulfilled,onRejected){var prom=new this.constructor(noop);handle(this,new Handler(onFulfilled,onRejected,prom));return prom};Promise.all=function(arr){var args=Array.prototype.slice.call(arr);return new Promise(function(resolve,reject){if(args.length===0)return resolve([]);var remaining=args.length;function res(i,val){try{if(val&&(typeof val==="object"||typeof val==="function")){var then=val.then;if(typeof then==="function"){then.call(val,function(val){res(i,val)},reject);return}}args[i]=val;if(--remaining===0){resolve(args)}}catch(ex){reject(ex)}}for(var i=0;i<args.length;i++){res(i,args[i])}})};Promise.resolve=function(value){if(value&&typeof value==="object"&&value.constructor===Promise){return value}return new Promise(function(resolve){resolve(value)})};Promise.reject=function(value){return new Promise(function(resolve,reject){reject(value)})};Promise.race=function(values){return new Promise(function(resolve,reject){for(var i=0,len=values.length;i<len;i++){values[i].then(resolve,reject)}})};Promise._immediateFn=typeof setImmediate==="function"&&function(fn){setImmediate(fn)}||function(fn){setTimeoutFunc(fn,0)};Promise._unhandledRejectionFn=function _unhandledRejectionFn(err){if(typeof console!=="undefined"&&console){console.warn("Possible Unhandled Promise Rejection:",err)}};Promise._setImmediateFn=function _setImmediateFn(fn){Promise._immediateFn=fn};Promise._setUnhandledRejectionFn=function _setUnhandledRejectionFn(fn){Promise._unhandledRejectionFn=fn};if(typeof module!=="undefined"&&module.exports){module.exports=Promise}else if(!root.Promise){root.Promise=Promise}})(this);function md5cycle(x,k){var a=x[0],b=x[1],c=x[2],d=x[3];a=ff(a,b,c,d,k[0],7,-680876936);d=ff(d,a,b,c,k[1],12,-389564586);c=ff(c,d,a,b,k[2],17,606105819);b=ff(b,c,d,a,k[3],22,-1044525330);a=ff(a,b,c,d,k[4],7,-176418897);d=ff(d,a,b,c,k[5],12,1200080426);c=ff(c,d,a,b,k[6],17,-1473231341);b=ff(b,c,d,a,k[7],22,-45705983);a=ff(a,b,c,d,k[8],7,1770035416);d=ff(d,a,b,c,k[9],12,-1958414417);c=ff(c,d,a,b,k[10],17,-42063);b=ff(b,c,d,a,k[11],22,-1990404162);a=ff(a,b,c,d,k[12],7,1804603682);d=ff(d,a,b,c,k[13],12,-40341101);c=ff(c,d,a,b,k[14],17,-1502002290);b=ff(b,c,d,a,k[15],22,1236535329);a=gg(a,b,c,d,k[1],5,-165796510);d=gg(d,a,b,c,k[6],9,-1069501632);c=gg(c,d,a,b,k[11],14,643717713);b=gg(b,c,d,a,k[0],20,-373897302);a=gg(a,b,c,d,k[5],5,-701558691);d=gg(d,a,b,c,k[10],9,38016083);c=gg(c,d,a,b,k[15],14,-660478335);b=gg(b,c,d,a,k[4],20,-405537848);a=gg(a,b,c,d,k[9],5,568446438);d=gg(d,a,b,c,k[14],9,-1019803690);c=gg(c,d,a,b,k[3],14,-187363961);b=gg(b,c,d,a,k[8],20,1163531501);a=gg(a,b,c,d,k[13],5,-1444681467);d=gg(d,a,b,c,k[2],9,-51403784);c=gg(c,d,a,b,k[7],14,1735328473);b=gg(b,c,d,a,k[12],20,-1926607734);a=hh(a,b,c,d,k[5],4,-378558);d=hh(d,a,b,c,k[8],11,-2022574463);c=hh(c,d,a,b,k[11],16,1839030562);b=hh(b,c,d,a,k[14],23,-35309556);a=hh(a,b,c,d,k[1],4,-1530992060);d=hh(d,a,b,c,k[4],11,1272893353);c=hh(c,d,a,b,k[7],16,-155497632);b=hh(b,c,d,a,k[10],23,-1094730640);a=hh(a,b,c,d,k[13],4,681279174);d=hh(d,a,b,c,k[0],11,-358537222);c=hh(c,d,a,b,k[3],16,-722521979);b=hh(b,c,d,a,k[6],23,76029189);a=hh(a,b,c,d,k[9],4,-640364487);d=hh(d,a,b,c,k[12],11,-421815835);c=hh(c,d,a,b,k[15],16,530742520);b=hh(b,c,d,a,k[2],23,-995338651);a=ii(a,b,c,d,k[0],6,-198630844);d=ii(d,a,b,c,k[7],10,1126891415);c=ii(c,d,a,b,k[14],15,-1416354905);b=ii(b,c,d,a,k[5],21,-57434055);a=ii(a,b,c,d,k[12],6,1700485571);d=ii(d,a,b,c,k[3],10,-1894986606);c=ii(c,d,a,b,k[10],15,-1051523);b=ii(b,c,d,a,k[1],21,-2054922799);a=ii(a,b,c,d,k[8],6,1873313359);d=ii(d,a,b,c,k[15],10,-30611744);c=ii(c,d,a,b,k[6],15,-1560198380);b=ii(b,c,d,a,k[13],21,1309151649);a=ii(a,b,c,d,k[4],6,-145523070);d=ii(d,a,b,c,k[11],10,-1120210379);c=ii(c,d,a,b,k[2],15,718787259);b=ii(b,c,d,a,k[9],21,-343485551);x[0]=add32(a,x[0]);x[1]=add32(b,x[1]);x[2]=add32(c,x[2]);x[3]=add32(d,x[3])}function cmn(q,a,b,x,s,t){a=add32(add32(a,q),add32(x,t));return add32(a<<s|a>>>32-s,b)}function ff(a,b,c,d,x,s,t){return cmn(b&c|~b&d,a,b,x,s,t)}function gg(a,b,c,d,x,s,t){return cmn(b&d|c&~d,a,b,x,s,t)}function hh(a,b,c,d,x,s,t){return cmn(b^c^d,a,b,x,s,t)}function ii(a,b,c,d,x,s,t){return cmn(c^(b|~d),a,b,x,s,t)}function md51(s){txt="";var n=s.length,state=[1732584193,-271733879,-1732584194,271733878],i;for(i=64;i<=s.length;i+=64){md5cycle(state,md5blk(s.substring(i-64,i)))}s=s.substring(i-64);var tail=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];for(i=0;i<s.length;i++)tail[i>>2]|=s.charCodeAt(i)<<(i%4<<3);tail[i>>2]|=128<<(i%4<<3);if(i>55){md5cycle(state,tail);for(i=0;i<16;i++)tail[i]=0}tail[14]=n*8;md5cycle(state,tail);return state}function md5blk(s){var md5blks=[],i;for(i=0;i<64;i+=4){md5blks[i>>2]=s.charCodeAt(i)+(s.charCodeAt(i+1)<<8)+(s.charCodeAt(i+2)<<16)+(s.charCodeAt(i+3)<<24)}return md5blks}var hex_chr="0123456789abcdef".split("");function rhex(n){var s="",j=0;for(;j<4;j++)s+=hex_chr[n>>j*8+4&15]+hex_chr[n>>j*8&15];return s}function hex(x){for(var i=0;i<x.length;i++)x[i]=rhex(x[i]);return x.join("")}function md5(s){return hex(md51(s))}function add32(a,b){return a+b&4294967295}if(md5("hello")!="5d41402abc4b2a76b9719d911017c592"){function add32(x,y){var lsw=(x&65535)+(y&65535),msw=(x>>16)+(y>>16)+(lsw>>16);return msw<<16|lsw&65535}}(function sortableModule(factory){"use strict";if(typeof define==="function"&&define.amd){define(factory)}else if(typeof module!="undefined"&&typeof module.exports!="undefined"){module.exports=factory()}else{window["Sortable"]=factory()}})(function sortableFactory(){"use strict";if(typeof window=="undefined"||!window.document){return function sortableError(){throw new Error("Sortable.js requires a window with a document")}}var dragEl,parentEl,ghostEl,cloneEl,rootEl,nextEl,lastDownEl,scrollEl,scrollParentEl,scrollCustomFn,lastEl,lastCSS,lastParentCSS,oldIndex,newIndex,activeGroup,putSortable,autoScroll={},tapEvt,touchEvt,moved,R_SPACE=/\s+/g,R_FLOAT=/left|right|inline/,expando="Sortable"+(new Date).getTime(),win=window,document=win.document,parseInt=win.parseInt,$=win.jQuery||win.Zepto,Polymer=win.Polymer,captureMode=false,supportDraggable=!!("draggable"in document.createElement("div")),supportCssPointerEvents=function(el){if(!!navigator.userAgent.match(/Trident.*rv[ :]?11\./)){return false}el=document.createElement("x");

el.style.cssText="pointer-events:auto";return el.style.pointerEvents==="auto"}(),_silent=false,abs=Math.abs,min=Math.min,savedInputChecked=[],touchDragOverListeners=[],_autoScroll=_throttle(function(evt,options,rootEl){if(rootEl&&options.scroll){var _this=rootEl[expando],el,rect,sens=options.scrollSensitivity,speed=options.scrollSpeed,x=evt.clientX,y=evt.clientY,winWidth=window.innerWidth,winHeight=window.innerHeight,vx,vy,scrollOffsetX,scrollOffsetY;if(scrollParentEl!==rootEl){scrollEl=options.scroll;scrollParentEl=rootEl;scrollCustomFn=options.scrollFn;if(scrollEl===true){scrollEl=rootEl;do{if(scrollEl.offsetWidth<scrollEl.scrollWidth||scrollEl.offsetHeight<scrollEl.scrollHeight){break}}while(scrollEl=scrollEl.parentNode)}}if(scrollEl){el=scrollEl;rect=scrollEl.getBoundingClientRect();vx=(abs(rect.right-x)<=sens)-(abs(rect.left-x)<=sens);vy=(abs(rect.bottom-y)<=sens)-(abs(rect.top-y)<=sens)}if(!(vx||vy)){vx=(winWidth-x<=sens)-(x<=sens);vy=(winHeight-y<=sens)-(y<=sens);(vx||vy)&&(el=win)}if(autoScroll.vx!==vx||autoScroll.vy!==vy||autoScroll.el!==el){autoScroll.el=el;autoScroll.vx=vx;autoScroll.vy=vy;clearInterval(autoScroll.pid);if(el){autoScroll.pid=setInterval(function(){scrollOffsetY=vy?vy*speed:0;scrollOffsetX=vx?vx*speed:0;if("function"===typeof scrollCustomFn){return scrollCustomFn.call(_this,scrollOffsetX,scrollOffsetY,evt)}if(el===win){win.scrollTo(win.pageXOffset+scrollOffsetX,win.pageYOffset+scrollOffsetY)}else{el.scrollTop+=scrollOffsetY;el.scrollLeft+=scrollOffsetX}},24)}}}},30),_prepareGroup=function(options){function toFn(value,pull){if(value===void 0||value===true){value=group.name}if(typeof value==="function"){return value}else{return function(to,from){var fromGroup=from.options.group.name;return pull?value:value&&(value.join?value.indexOf(fromGroup)>-1:fromGroup==value)}}}var group={};var originalGroup=options.group;if(!originalGroup||typeof originalGroup!="object"){originalGroup={name:originalGroup}}group.name=originalGroup.name;group.checkPull=toFn(originalGroup.pull,true);group.checkPut=toFn(originalGroup.put);group.revertClone=originalGroup.revertClone;options.group=group};function Sortable(el,options){if(!(el&&el.nodeType&&el.nodeType===1)){throw"Sortable: `el` must be HTMLElement, and not "+{}.toString.call(el)}this.el=el;this.options=options=_extend({},options);el[expando]=this;var defaults={group:Math.random(),sort:true,disabled:false,store:null,handle:null,scroll:true,scrollSensitivity:30,scrollSpeed:10,draggable:/[uo]l/i.test(el.nodeName)?"li":">*",ghostClass:"sortable-ghost",chosenClass:"sortable-chosen",dragClass:"sortable-drag",ignore:"a, img",filter:null,preventOnFilter:true,animation:0,setData:function(dataTransfer,dragEl){dataTransfer.setData("Text",dragEl.textContent)},dropBubble:false,dragoverBubble:false,dataIdAttr:"data-id",delay:0,forceFallback:false,fallbackClass:"sortable-fallback",fallbackOnBody:false,fallbackTolerance:0,fallbackOffset:{x:0,y:0}};for(var name in defaults){!(name in options)&&(options[name]=defaults[name])}_prepareGroup(options);for(var fn in this){if(fn.charAt(0)==="_"&&typeof this[fn]==="function"){this[fn]=this[fn].bind(this)}}this.nativeDraggable=options.forceFallback?false:supportDraggable;_on(el,"mousedown",this._onTapStart);_on(el,"touchstart",this._onTapStart);_on(el,"pointerdown",this._onTapStart);if(this.nativeDraggable){_on(el,"dragover",this);_on(el,"dragenter",this)}touchDragOverListeners.push(this._onDragOver);options.store&&this.sort(options.store.get(this))}Sortable.prototype={constructor:Sortable,_onTapStart:function(evt){var _this=this,el=this.el,options=this.options,preventOnFilter=options.preventOnFilter,type=evt.type,touch=evt.touches&&evt.touches[0],target=(touch||evt).target,originalTarget=evt.target.shadowRoot&&evt.path[0]||target,filter=options.filter,startIndex;_saveInputCheckedState(el);if(dragEl){return}if(type==="mousedown"&&evt.button!==0||options.disabled){return}target=_closest(target,options.draggable,el);if(!target){return}if(lastDownEl===target){return}startIndex=_index(target,options.draggable);if(typeof filter==="function"){if(filter.call(this,evt,target,this)){_dispatchEvent(_this,originalTarget,"filter",target,el,startIndex);preventOnFilter&&evt.preventDefault();return}}else if(filter){filter=filter.split(",").some(function(criteria){criteria=_closest(originalTarget,criteria.trim(),el);if(criteria){_dispatchEvent(_this,criteria,"filter",target,el,startIndex);return true}});if(filter){preventOnFilter&&evt.preventDefault();return}}if(options.handle&&!_closest(originalTarget,options.handle,el)){return}this._prepareDragStart(evt,touch,target,startIndex)},_prepareDragStart:function(evt,touch,target,startIndex){var _this=this,el=_this.el,options=_this.options,ownerDocument=el.ownerDocument,dragStartFn;if(target&&!dragEl&&target.parentNode===el){tapEvt=evt;rootEl=el;dragEl=target;parentEl=dragEl.parentNode;nextEl=dragEl.nextSibling;lastDownEl=target;activeGroup=options.group;oldIndex=startIndex;this._lastX=(touch||evt).clientX;this._lastY=(touch||evt).clientY;dragEl.style["will-change"]="transform";dragStartFn=function(){_this._disableDelayedDrag();dragEl.draggable=_this.nativeDraggable;_toggleClass(dragEl,options.chosenClass,true);_this._triggerDragStart(evt,touch);_dispatchEvent(_this,rootEl,"choose",dragEl,rootEl,oldIndex)};options.ignore.split(",").forEach(function(criteria){_find(dragEl,criteria.trim(),_disableDraggable)});_on(ownerDocument,"mouseup",_this._onDrop);_on(ownerDocument,"touchend",_this._onDrop);_on(ownerDocument,"touchcancel",_this._onDrop);_on(ownerDocument,"pointercancel",_this._onDrop);_on(ownerDocument,"selectstart",_this);if(options.delay){_on(ownerDocument,"mouseup",_this._disableDelayedDrag);_on(ownerDocument,"touchend",_this._disableDelayedDrag);_on(ownerDocument,"touchcancel",_this._disableDelayedDrag);_on(ownerDocument,"mousemove",_this._disableDelayedDrag);_on(ownerDocument,"touchmove",_this._disableDelayedDrag);_on(ownerDocument,"pointermove",_this._disableDelayedDrag);_this._dragStartTimer=setTimeout(dragStartFn,options.delay)}else{dragStartFn()}}},_disableDelayedDrag:function(){var ownerDocument=this.el.ownerDocument;clearTimeout(this._dragStartTimer);_off(ownerDocument,"mouseup",this._disableDelayedDrag);_off(ownerDocument,"touchend",this._disableDelayedDrag);_off(ownerDocument,"touchcancel",this._disableDelayedDrag);_off(ownerDocument,"mousemove",this._disableDelayedDrag);_off(ownerDocument,"touchmove",this._disableDelayedDrag);_off(ownerDocument,"pointermove",this._disableDelayedDrag)},_triggerDragStart:function(evt,touch){touch=touch||(evt.pointerType=="touch"?evt:null);if(touch){tapEvt={target:dragEl,clientX:touch.clientX,clientY:touch.clientY};this._onDragStart(tapEvt,"touch")}else if(!this.nativeDraggable){this._onDragStart(tapEvt,true)}else{_on(dragEl,"dragend",this);_on(rootEl,"dragstart",this._onDragStart)}try{if(document.selection){setTimeout(function(){document.selection.empty()})}else{window.getSelection().removeAllRanges()}}catch(err){}},_dragStarted:function(){if(rootEl&&dragEl){var options=this.options;_toggleClass(dragEl,options.ghostClass,true);_toggleClass(dragEl,options.dragClass,false);Sortable.active=this;_dispatchEvent(this,rootEl,"start",dragEl,rootEl,oldIndex)}else{this._nulling()}},_emulateDragOver:function(){if(touchEvt){if(this._lastX===touchEvt.clientX&&this._lastY===touchEvt.clientY){return}this._lastX=touchEvt.clientX;this._lastY=touchEvt.clientY;if(!supportCssPointerEvents){_css(ghostEl,"display","none")}var target=document.elementFromPoint(touchEvt.clientX,touchEvt.clientY),parent=target,i=touchDragOverListeners.length;if(parent){do{if(parent[expando]){while(i--){touchDragOverListeners[i]({clientX:touchEvt.clientX,clientY:touchEvt.clientY,target:target,rootEl:parent})}break}target=parent}while(parent=parent.parentNode)}if(!supportCssPointerEvents){_css(ghostEl,"display","")}}},_onTouchMove:function(evt){if(tapEvt){var options=this.options,fallbackTolerance=options.fallbackTolerance,fallbackOffset=options.fallbackOffset,touch=evt.touches?evt.touches[0]:evt,dx=touch.clientX-tapEvt.clientX+fallbackOffset.x,dy=touch.clientY-tapEvt.clientY+fallbackOffset.y,translate3d=evt.touches?"translate3d("+dx+"px,"+dy+"px,0)":"translate("+dx+"px,"+dy+"px)";if(!Sortable.active){if(fallbackTolerance&&min(abs(touch.clientX-this._lastX),abs(touch.clientY-this._lastY))<fallbackTolerance){return}this._dragStarted()}this._appendGhost();moved=true;touchEvt=touch;_css(ghostEl,"webkitTransform",translate3d);_css(ghostEl,"mozTransform",translate3d);_css(ghostEl,"msTransform",translate3d);_css(ghostEl,"transform",translate3d);evt.preventDefault()}},_appendGhost:function(){if(!ghostEl){var rect=dragEl.getBoundingClientRect(),css=_css(dragEl),options=this.options,ghostRect;ghostEl=dragEl.cloneNode(true);_toggleClass(ghostEl,options.ghostClass,false);_toggleClass(ghostEl,options.fallbackClass,true);_toggleClass(ghostEl,options.dragClass,true);_css(ghostEl,"top",rect.top-parseInt(css.marginTop,10));_css(ghostEl,"left",rect.left-parseInt(css.marginLeft,10));_css(ghostEl,"width",rect.width);_css(ghostEl,"height",rect.height);_css(ghostEl,"opacity","0.8");_css(ghostEl,"position","fixed");_css(ghostEl,"zIndex","100000");_css(ghostEl,"pointerEvents","none");options.fallbackOnBody&&document.body.appendChild(ghostEl)||rootEl.appendChild(ghostEl);ghostRect=ghostEl.getBoundingClientRect();_css(ghostEl,"width",rect.width*2-ghostRect.width);_css(ghostEl,"height",rect.height*2-ghostRect.height)}},_onDragStart:function(evt,useFallback){var dataTransfer=evt.dataTransfer,options=this.options;this._offUpEvents();if(activeGroup.checkPull(this,this,dragEl,evt)){cloneEl=_clone(dragEl);cloneEl.draggable=false;cloneEl.style["will-change"]="";_css(cloneEl,"display","none");_toggleClass(cloneEl,this.options.chosenClass,false);rootEl.insertBefore(cloneEl,dragEl);_dispatchEvent(this,rootEl,"clone",dragEl)}_toggleClass(dragEl,options.dragClass,true);if(useFallback){if(useFallback==="touch"){_on(document,"touchmove",this._onTouchMove);_on(document,"touchend",this._onDrop);_on(document,"touchcancel",this._onDrop);_on(document,"pointermove",this._onTouchMove);_on(document,"pointerup",this._onDrop)}else{_on(document,"mousemove",this._onTouchMove);_on(document,"mouseup",this._onDrop)}this._loopId=setInterval(this._emulateDragOver,50)}else{if(dataTransfer){dataTransfer.effectAllowed="move";options.setData&&options.setData.call(this,dataTransfer,dragEl)}_on(document,"drop",this);setTimeout(this._dragStarted,0)}},_onDragOver:function(evt){var el=this.el,target,dragRect,targetRect,revert,options=this.options,group=options.group,activeSortable=Sortable.active,isOwner=activeGroup===group,isMovingBetweenSortable=false,canSort=options.sort;if(evt.preventDefault!==void 0){evt.preventDefault();!options.dragoverBubble&&evt.stopPropagation()}if(dragEl.animated){return}moved=true;if(activeSortable&&!options.disabled&&(isOwner?canSort||(revert=!rootEl.contains(dragEl)):putSortable===this||(activeSortable.lastPullMode=activeGroup.checkPull(this,activeSortable,dragEl,evt))&&group.checkPut(this,activeSortable,dragEl,evt))&&(evt.rootEl===void 0||evt.rootEl===this.el)){_autoScroll(evt,options,this.el);if(_silent){return}target=_closest(evt.target,options.draggable,el);dragRect=dragEl.getBoundingClientRect();if(putSortable!==this){putSortable=this;isMovingBetweenSortable=true}if(revert){_cloneHide(activeSortable,true);parentEl=rootEl;if(cloneEl||nextEl){rootEl.insertBefore(dragEl,cloneEl||nextEl)}else if(!canSort){rootEl.appendChild(dragEl)}return}if(el.children.length===0||el.children[0]===ghostEl||el===evt.target&&_ghostIsLast(el,evt)){if(el.children.length!==0&&el.children[0]!==ghostEl&&el===evt.target){target=el.lastElementChild}if(target){if(target.animated){return}targetRect=target.getBoundingClientRect()}_cloneHide(activeSortable,isOwner);if(_onMove(rootEl,el,dragEl,dragRect,target,targetRect,evt)!==false){if(!dragEl.contains(el)){el.appendChild(dragEl);parentEl=el}this._animate(dragRect,dragEl);target&&this._animate(targetRect,target)}}else if(target&&!target.animated&&target!==dragEl&&target.parentNode[expando]!==void 0){if(lastEl!==target){lastEl=target;lastCSS=_css(target);lastParentCSS=_css(target.parentNode)}targetRect=target.getBoundingClientRect();var width=targetRect.right-targetRect.left,height=targetRect.bottom-targetRect.top,floating=R_FLOAT.test(lastCSS.cssFloat+lastCSS.display)||lastParentCSS.display=="flex"&&lastParentCSS["flex-direction"].indexOf("row")===0,isWide=target.offsetWidth>dragEl.offsetWidth,isLong=target.offsetHeight>dragEl.offsetHeight,halfway=(floating?(evt.clientX-targetRect.left)/width:(evt.clientY-targetRect.top)/height)>.5,nextSibling=target.nextElementSibling,after=false;if(floating){var elTop=dragEl.offsetTop,tgTop=target.offsetTop;if(elTop===tgTop){after=target.previousElementSibling===dragEl&&!isWide||halfway&&isWide}else if(target.previousElementSibling===dragEl||dragEl.previousElementSibling===target){after=(evt.clientY-targetRect.top)/height>.5}else{after=tgTop>elTop}}else if(!isMovingBetweenSortable){after=nextSibling!==dragEl&&!isLong||halfway&&isLong}var moveVector=_onMove(rootEl,el,dragEl,dragRect,target,targetRect,evt,after);if(moveVector!==false){if(moveVector===1||moveVector===-1){after=moveVector===1}_silent=true;setTimeout(_unsilent,30);_cloneHide(activeSortable,isOwner);if(!dragEl.contains(el)){if(after&&!nextSibling){el.appendChild(dragEl)}else{target.parentNode.insertBefore(dragEl,after?nextSibling:target)}}parentEl=dragEl.parentNode;this._animate(dragRect,dragEl);this._animate(targetRect,target)}}}},_animate:function(prevRect,target){var ms=this.options.animation;if(ms){var currentRect=target.getBoundingClientRect();if(prevRect.nodeType===1){prevRect=prevRect.getBoundingClientRect()}_css(target,"transition","none");_css(target,"transform","translate3d("+(prevRect.left-currentRect.left)+"px,"+(prevRect.top-currentRect.top)+"px,0)");target.offsetWidth;_css(target,"transition","all "+ms+"ms");_css(target,"transform","translate3d(0,0,0)");clearTimeout(target.animated);target.animated=setTimeout(function(){_css(target,"transition","");_css(target,"transform","");target.animated=false},ms)}},_offUpEvents:function(){var ownerDocument=this.el.ownerDocument;_off(document,"touchmove",this._onTouchMove);_off(document,"pointermove",this._onTouchMove);_off(ownerDocument,"mouseup",this._onDrop);_off(ownerDocument,"touchend",this._onDrop);_off(ownerDocument,"pointerup",this._onDrop);_off(ownerDocument,"touchcancel",this._onDrop);_off(ownerDocument,"pointercancel",this._onDrop);_off(ownerDocument,"selectstart",this)},_onDrop:function(evt){var el=this.el,options=this.options;clearInterval(this._loopId);clearInterval(autoScroll.pid);clearTimeout(this._dragStartTimer);_off(document,"mousemove",this._onTouchMove);if(this.nativeDraggable){_off(document,"drop",this);_off(el,"dragstart",this._onDragStart)}this._offUpEvents();if(evt){if(moved){evt.preventDefault();!options.dropBubble&&evt.stopPropagation()}ghostEl&&ghostEl.parentNode&&ghostEl.parentNode.removeChild(ghostEl);if(rootEl===parentEl||Sortable.active.lastPullMode!=="clone"){cloneEl&&cloneEl.parentNode&&cloneEl.parentNode.removeChild(cloneEl)}if(dragEl){if(this.nativeDraggable){_off(dragEl,"dragend",this)}_disableDraggable(dragEl);dragEl.style["will-change"]="";_toggleClass(dragEl,this.options.ghostClass,false);_toggleClass(dragEl,this.options.chosenClass,false);_dispatchEvent(this,rootEl,"unchoose",dragEl,rootEl,oldIndex);if(rootEl!==parentEl){newIndex=_index(dragEl,options.draggable);if(newIndex>=0){_dispatchEvent(null,parentEl,"add",dragEl,rootEl,oldIndex,newIndex);_dispatchEvent(this,rootEl,"remove",dragEl,rootEl,oldIndex,newIndex);_dispatchEvent(null,parentEl,"sort",dragEl,rootEl,oldIndex,newIndex);_dispatchEvent(this,rootEl,"sort",dragEl,rootEl,oldIndex,newIndex)}}else{if(dragEl.nextSibling!==nextEl){newIndex=_index(dragEl,options.draggable);if(newIndex>=0){_dispatchEvent(this,rootEl,"update",dragEl,rootEl,oldIndex,newIndex);_dispatchEvent(this,rootEl,"sort",dragEl,rootEl,oldIndex,newIndex)}}}if(Sortable.active){if(newIndex==null||newIndex===-1){newIndex=oldIndex}_dispatchEvent(this,rootEl,"end",dragEl,rootEl,oldIndex,newIndex);this.save()}}}this._nulling()},_nulling:function(){rootEl=dragEl=parentEl=ghostEl=nextEl=cloneEl=lastDownEl=scrollEl=scrollParentEl=tapEvt=touchEvt=moved=newIndex=lastEl=lastCSS=putSortable=activeGroup=Sortable.active=null;savedInputChecked.forEach(function(el){el.checked=true});savedInputChecked.length=0},handleEvent:function(evt){switch(evt.type){case"drop":case"dragend":this._onDrop(evt);break;case"dragover":case"dragenter":if(dragEl){this._onDragOver(evt);_globalDragOver(evt)}break;case"selectstart":evt.preventDefault();break}},toArray:function(){var order=[],el,children=this.el.children,i=0,n=children.length,options=this.options;for(;i<n;i++){el=children[i];if(_closest(el,options.draggable,this.el)){order.push(el.getAttribute(options.dataIdAttr)||_generateId(el))}}return order},sort:function(order){var items={},rootEl=this.el;this.toArray().forEach(function(id,i){var el=rootEl.children[i];if(_closest(el,this.options.draggable,rootEl)){items[id]=el}},this);order.forEach(function(id){if(items[id]){rootEl.removeChild(items[id]);rootEl.appendChild(items[id])}})},save:function(){var store=this.options.store;store&&store.set(this)},closest:function(el,selector){return _closest(el,selector||this.options.draggable,this.el)},option:function(name,value){var options=this.options;if(value===void 0){return options[name]}else{options[name]=value;if(name==="group"){_prepareGroup(options)}}},destroy:function(){var el=this.el;el[expando]=null;_off(el,"mousedown",this._onTapStart);_off(el,"touchstart",this._onTapStart);_off(el,"pointerdown",this._onTapStart);if(this.nativeDraggable){_off(el,"dragover",this);_off(el,"dragenter",this)}Array.prototype.forEach.call(el.querySelectorAll("[draggable]"),function(el){el.removeAttribute("draggable")});touchDragOverListeners.splice(touchDragOverListeners.indexOf(this._onDragOver),1);this._onDrop();this.el=el=null}};function _cloneHide(sortable,state){if(sortable.lastPullMode!=="clone"){state=true}if(cloneEl&&cloneEl.state!==state){_css(cloneEl,"display",state?"none":"");if(!state){if(cloneEl.state){if(sortable.options.group.revertClone){rootEl.insertBefore(cloneEl,nextEl);sortable._animate(dragEl,cloneEl)}else{rootEl.insertBefore(cloneEl,dragEl)}}}cloneEl.state=state}}function _closest(el,selector,ctx){if(el){ctx=ctx||document;do{if(selector===">*"&&el.parentNode===ctx||_matches(el,selector)){return el}}while(el=_getParentOrHost(el))}return null}function _getParentOrHost(el){var parent=el.host;return parent&&parent.nodeType?parent:el.parentNode}function _globalDragOver(evt){if(evt.dataTransfer){evt.dataTransfer.dropEffect="move"}evt.preventDefault()}function _on(el,event,fn){el.addEventListener(event,fn,captureMode)}function _off(el,event,fn){el.removeEventListener(event,fn,captureMode)}function _toggleClass(el,name,state){if(el){if(el.classList){el.classList[state?"add":"remove"](name)}else{var className=(" "+el.className+" ").replace(R_SPACE," ").replace(" "+name+" "," ");el.className=(className+(state?" "+name:"")).replace(R_SPACE," ")}}}function _css(el,prop,val){var style=el&&el.style;if(style){if(val===void 0){if(document.defaultView&&document.defaultView.getComputedStyle){val=document.defaultView.getComputedStyle(el,"")}else if(el.currentStyle){val=el.currentStyle}return prop===void 0?val:val[prop]}else{if(!(prop in style)){prop="-webkit-"+prop}style[prop]=val+(typeof val==="string"?"":"px")}}}function _find(ctx,tagName,iterator){if(ctx){var list=ctx.getElementsByTagName(tagName),i=0,n=list.length;if(iterator){for(;i<n;i++){iterator(list[i],i)}}return list}return[]}function _dispatchEvent(sortable,rootEl,name,targetEl,fromEl,startIndex,newIndex){sortable=sortable||rootEl[expando];var evt=document.createEvent("Event"),options=sortable.options,onName="on"+name.charAt(0).toUpperCase()+name.substr(1);evt.initEvent(name,true,true);evt.to=rootEl;evt.from=fromEl||rootEl;evt.item=targetEl||rootEl;evt.clone=cloneEl;evt.oldIndex=startIndex;evt.newIndex=newIndex;rootEl.dispatchEvent(evt);if(options[onName]){options[onName].call(sortable,evt)}}function _onMove(fromEl,toEl,dragEl,dragRect,targetEl,targetRect,originalEvt,willInsertAfter){var evt,sortable=fromEl[expando],onMoveFn=sortable.options.onMove,retVal;evt=document.createEvent("Event");evt.initEvent("move",true,true);evt.to=toEl;evt.from=fromEl;evt.dragged=dragEl;evt.draggedRect=dragRect;evt.related=targetEl||toEl;evt.relatedRect=targetRect||toEl.getBoundingClientRect();evt.willInsertAfter=willInsertAfter;fromEl.dispatchEvent(evt);if(onMoveFn){retVal=onMoveFn.call(sortable,evt,originalEvt)}return retVal}function _disableDraggable(el){el.draggable=false}function _unsilent(){_silent=false}function _ghostIsLast(el,evt){var lastEl=el.lastElementChild,rect=lastEl.getBoundingClientRect();return evt.clientY-(rect.top+rect.height)>5||evt.clientX-(rect.left+rect.width)>5}function _generateId(el){var str=el.tagName+el.className+el.src+el.href+el.textContent,i=str.length,sum=0;while(i--){sum+=str.charCodeAt(i)}return sum.toString(36)}function _index(el,selector){var index=0;if(!el||!el.parentNode){return-1}while(el&&(el=el.previousElementSibling)){if(el.nodeName.toUpperCase()!=="TEMPLATE"&&(selector===">*"||_matches(el,selector))){index++}}return index}function _matches(el,selector){if(el){selector=selector.split(".");var tag=selector.shift().toUpperCase(),re=new RegExp("\\s("+selector.join("|")+")(?=\\s)","g");return(tag===""||el.nodeName.toUpperCase()==tag)&&(!selector.length||((" "+el.className+" ").match(re)||[]).length==selector.length)}return false}function _throttle(callback,ms){var args,_this;return function(){if(args===void 0){args=arguments;_this=this;setTimeout(function(){if(args.length===1){callback.call(_this,args[0])}else{callback.apply(_this,args)}args=void 0},ms)}}}function _extend(dst,src){if(dst&&src){for(var key in src){if(src.hasOwnProperty(key)){dst[key]=src[key]}}}return dst}function _clone(el){return $?$(el).clone(true)[0]:Polymer&&Polymer.dom?Polymer.dom(el).cloneNode(true):el.cloneNode(true)}function _saveInputCheckedState(root){var inputs=root.getElementsByTagName("input");var idx=inputs.length;while(idx--){var el=inputs[idx];el.checked&&savedInputChecked.push(el)}}_on(document,"touchmove",function(evt){if(Sortable.active){evt.preventDefault()}});try{window.addEventListener("test",null,Object.defineProperty({},"passive",{get:function(){captureMode={capture:false,passive:false}}}))}catch(err){}Sortable.utils={on:_on,off:_off,css:_css,find:_find,is:function(el,selector){return!!_closest(el,selector,el)},extend:_extend,throttle:_throttle,closest:_closest,toggleClass:_toggleClass,clone:_clone,index:_index};Sortable.create=function(el,options){return new Sortable(el,options)};Sortable.version="1.6.0";return Sortable});var History=function(element){this.el=element;this.limit=10;this.history=[];var EMPTY="";var index=null;var current=null;this.up=function(){var history=this.history.concat(this.tail());if(index===null){index=0}else if(++index>=history.length){index=0}this.el.value=history[index]};this.tail=function(rev){var current=this.current();var tail=[EMPTY];if(current!=EMPTY)tail.push(current);return tail};this.current=function(){if(current===null){current=this.el.value}return current};this.reset=function(){current=null;index=null};this.down=function(){var history=this.history.concat(this.tail(true));if(index===null){index=0}else if(--index<0){index=history.length-1}this.el.value=history[index]};this.record=function(){this.history.unshift(this.el.value);current=null;if(this.history.length>this.limit)this.history=this.history.slice(0,this.limit)}};var Stream=function(baseurl){var stream=this;stream.baseurl=baseurl;stream.retries=0;stream.eventsource=null;stream.last_id=null;var listeners={};stream.on=function(name,func){if(!listeners[name])listeners[name]=[];listeners[name].push(func)};stream.fire=function(name){if(listeners[name]){var data=Array.prototype.slice.call(arguments,1);listeners[name].forEach(function(listener){data.unshift(listener,0);setTimeout.apply(undefined,data)})}};function connect(){var url=stream.baseurl+"/events";var es=new EventSource(url);es.addEventListener("irc",stream.onmessage);es.addEventListener("open",stream.onopen);es.addEventListener("error",stream.close);stream.eventsource=es;stream.timer=null}stream.connect=function(){if(stream.eventsource)stream.eventsource.close();var backoff=Math.max(3,Math.min(stream.retries++,15));console.log("reconnecting in "+backoff+" seconds");stream.fire("reconnect-status","Reconnecting in "+backoff+" seconds");function count(){if(--backoff<=0){clearTimeout(stream.timer);connect()}else{stream.fire("reconnect-status","Reconnecting in "+backoff+" seconds");stream.timer=setTimeout(count,1e3)}}stream.timer=setTimeout(count,1e3)};stream.onconnect=function(e){var data=JSON.parse(e.data);stream.fire("connect",data)};stream.onopen=function(){stream.fire("open");stream.retries=0};stream.onmessage=function(e){var data=JSON.parse(e.data);if(data.Message.Command=="CREATE"){stream.fire("create_connection",data)}else if(data.Message.Command=="DELETE"){stream.fire("delete_connection",data)}else{if(data.MessageId)stream.last_id=data.MessageId;stream.fire("message",data)}};stream.close=function(){if(stream.eventsource)stream.eventsource.close()};stream.check=function(){if(!stream.timer){if(stream.retries==0&&(!stream.eventsource||stream.eventsource.readyState!=1)){stream.fire("close");console.log("closed")}if(!stream.eventsource||stream.eventsource.readyState==2){stream.connect()}else if(stream.eventsource.readyState==0){if(stream.retries==0){stream.retries=1}console.log("reconnecting now");stream.fire("reconnect-status","Reconnecting now")}}};connect();var timer=setInterval(stream.check,1e3);stream.destroy=function(){clearInterval(timer);listeners={};if(stream.eventsource){stream.eventsource.removeEventListener("irc",stream.onmessage);stream.eventsource.removeEventListener("open",stream.onopen);stream.eventsource.close()}stream=null}};var Unformat=function(html){var parser=new DOMParser;var doc=parser.parseFromString(html,"text/html");var block=["DIV"];var tags={B:"",U:"",I:""};function descend(node,string){if(node.nodeType==3){string+=node.textContent}else if(node.nodeType==1||node.nodeType==9){if(block.indexOf(node.nodeName)!=-1)string+="\n";if(tags[node.nodeName])string+=tags[node.nodeName];for(var i=0;i<node.childNodes.length;i++){string=descend(node.childNodes[i],string)}if(tags[node.nodeName])string+=tags[node.nodeName]}return string}return descend(doc,"")};var Format=function(text){function parse(acc,tokens){if(tokens.length==0)return acc;var token=tokens.shift();var head=acc.length?acc[acc.length-1]:make();var node=clone(head);switch(token.substring(0,1)){case"":var colors=token.substring(1).split(",",2);node.color=colors[0];node.background=colors[1];break;case"":node.bold=!head.bold;break;case"":node=make();break;case"":node.italic=!head.italic;break;case"":node.underline=!head.underline;break;case"":node.color=head.background===null?0:head.background;node.background=head.color===null?1:head.color;break;default:node.text+=token}acc.push(node);return parse(acc,tokens)}var color_map=["white","black","navy","green","red","maroon","purple","olive","yellow","lightgreen","teal","cyan","royalblue","magenta","gray","lightgray"];function make(){return{text:"",color:null,background:null,bold:false,italic:false,underline:false}}function clone(node){return{text:"",color:node.color,background:node.background,bold:node.bold,italic:node.italic,underline:node.underline}}var split=/(\x03\d{0,2}(?:,\d{1,2})?|\x0F|\x1D|\x1F|\x16|\x02)/;var tokens=text.split(split);if(tokens.length==1)return[document.createTextNode(text)];return parse([],tokens).filter(function(item){return item.text!=""}).map(function(item){var span=document.createElement("SPAN");span.textContent=item.text;if(item.background!=null)span.style.backgroundColor=color_map[item.background];if(item.color!=null)span.style.color=color_map[item.color];if(item.bold)span.style.fontWeight="bold";if(item.italic)span.style.fontStyle="italic";if(item.underline)span.style.textDecoration="underline";return span})};var Auth=function(baseurl){var baseurl=baseurl;this.auth=function(complete){fetch(baseurl+"/auth",{credentials:"same-origin"}).then(function(res){if(!res.ok)throw Error(res.statusText);return res.json()}).then(function(res){complete(res)}).catch(function(e){console.log(e);modal_overlay(complete)})};function modal_overlay(complete){var overlay=document.createElement("DIV");overlay.setAttribute("class","overlay");var login=document.querySelector(".login").cloneNode(true);overlay.appendChild(login);document.body.appendChild(overlay);if(!("ontouchstart"in document.documentElement)){overlay.querySelector('.login-form input[name="email"]').focus()}overlay.addEventListener("submit",function(e){e.preventDefault();var action=e.target.querySelector('input[type="submit"]').getAttribute("name");var email=e.target.querySelector('input[name="email"]').value;var pass=e.target.querySelector('input[type="password"]').value;var body="";body+="email="+encodeURIComponent(email);body+="&pass="+encodeURIComponent(pass);if(action=="register"){var user=e.target.querySelector('input[name="username"]').value;body+="&username="+encodeURIComponent(user)}fetch(baseurl+"/"+action,{credentials:"same-origin",method:"POST",body:body,headers:{"content-type":"application/x-www-form-urlencoded; charset=UTF-8"}}).then(function(res){if(!res.ok)throw Error(res.statusText);return res.json()}).then(function(res){overlay.remove();complete(res)}).catch(function(e){alert("Sorry, that didn't work...")})});overlay.querySelector(".login-toggle").addEventListener("click",function(e){e.preventDefault();overlay.querySelector(".login-wrap").style.display="block";overlay.querySelector(".reset-wrap").style.display="none";overlay.querySelector('.login-form input[name="email"]').focus()});overlay.querySelector(".reset-toggle").addEventListener("click",function(e){e.preventDefault();console.log(e);overlay.querySelector(".login-wrap").style.display="none";overlay.querySelector(".reset-wrap").style.display="block";overlay.querySelector('.reset-wrap input[name="email"]').focus()})}};var UIEvents=function(liercd){var liercd=liercd;var events=this;var mods={meta:false,shift:false,ctrl:false,cmd:false};var commands=new Commands(liercd);document.addEventListener("keydown",function(e){if(e.which==17){mods["ctrl"]=true;return}else if(e.which==18){mods["meta"]=true;return}else if(e.which==16){mods["shift"]=true;return}else if(e.which==91||e.which==93||e.which==224){mods["cmd"]=true;return}else if(e.which==27&&liercd.overlayed){document.querySelectorAll(".overlay").forEach(function(el){el.parentNode.removeChild(el)});liercd.overlayed=false;return}else if(liercd.overlayed){return}if(liercd.elem.switcher.classList.contains("open")){if(e.which==27){liercd.hide_switcher();liercd.focus_input();return}else if(e.which==40||e.which==9){e.preventDefault();var items=liercd.elem.nav.querySelectorAll("li[data-name].candidate.match");for(var i=1;i<items.length;i++){if(items[i-1].classList.contains("selected")){items[i-1].classList.remove("selected");items[i].classList.add("selected");return}}}else if(e.which==38){e.preventDefault();var items=liercd.elem.nav.querySelectorAll("li[data-name].candidate.match");for(var i=0;i<items.length-1;i++){if(items[i+1].classList.contains("selected")){items[i+1].classList.remove("selected");items[i].classList.add("selected");return}}}else if(e.which==13){var selected=liercd.elem.nav.querySelector("li.selected");if(selected){var id=selected.getAttribute("data-panel-id");liercd.focus_panel(id);liercd.hide_switcher()}}}if(e.which==13&&!mods["shift"]){e.preventDefault();send_submit();return}else if(e.which==38&&mods["meta"]){e.preventDefault();

mods["shift"]?liercd.prev_unread_panel():liercd.prev_panel();return}else if(e.which==40&&mods["meta"]){e.preventDefault();mods["shift"]?liercd.next_unread_panel():liercd.next_panel();return}else if((e.which==75||e.which==84)&&mods["meta"]){e.preventDefault();liercd.toggle_switcher();return}var c=String.fromCharCode(e.which);if((mods["cmd"]||mods["meta"])&&c.match(/^[1-9]$/)){var panels=liercd.elem.nav.querySelectorAll("#channels li,#privates li");if(panels[c-1]){liercd.focus_panel(panels[c-1].getAttribute("data-panel-id"));return}}if(liercd.focused){if(liercd.focused.keyboard.focused){liercd.focused.keyboard.keydown(e,mods)}else if(e.target.nodeName!="INPUT"&&e.target.nodeName!="TEXTAREA"&&!mods["meta"]&&!mods["ctrl"]&&!mods["cmd"]&&(c.match(/[a-zA-Z0-9\/]/)||e.which==191)){liercd.focus_input()}}});liercd.elem.switcher.addEventListener("input",function(e){var val=liercd.elem.switcher.querySelector("input").value;var items=liercd.elem.nav.querySelectorAll("li[data-name]");val=val.toLowerCase();if(val){for(var i=0;i<items.length;i++){var item=items[i];var text=item.getAttribute("data-name").toLowerCase();if(text.indexOf(val)==-1){item.classList.remove("match")}else{item.classList.add("match")}}}else{liercd.elem.nav.querySelectorAll("li[data-name]").forEach(function(el){el.classList.add("match")})}for(var i=0;i<items.length;i++){if(items[i].classList.contains("selected")){if(items[i].classList.contains("match"))return;for(var j=i;j<items.length;j++){if(items[j].classList.contains("match")){items[i].classList.remove("selected");items[j].classList.add("selected");return}}for(var k=i;k>=0;k--){if(items[k].classList.contains("match")){items[i].classList.remove("selected");items[k].classList.add("selected");return}}}}});window.addEventListener("blur",function(e){mods["shift"]=false;mods["meta"]=false;mods["ctrl"]=false;mods["cmd"]=false;liercd.window_focused=false});window.addEventListener("focus",function(e){mods["shift"]=false;mods["meta"]=false;mods["ctrl"]=false;mods["cmd"]=false;liercd.window_focused=true;liercd.focus_input()});document.addEventListener("keyup",function(e){if(e.which==18)mods["meta"]=false;if(e.which==16)mods["shift"]=false;if(e.which==17)mods["ctrl"]=false;if(e.which==91)mods["cmd"]=false});document.addEventListener("click",function(e){if(e.target.hasAttribute("data-nick")){e.preventDefault();var nick=e.target.getAttribute("data-nick");var connection=liercd.focused.connection;var panel=liercd.add_panel(nick,connection,true);liercd.focus_panel(panel.id)}});function join_click(e){e.preventDefault();liercd.elem.flex_wrap.classList.remove("open");var overlay=document.createElement("DIV");overlay.classList.add("overlay");var join=document.querySelector(".dialog.join").cloneNode(true);overlay.appendChild(join);liercd.elem.body.appendChild(overlay);liercd.overlayed=true;["touchstart","click"].forEach(function(t){overlay.addEventListener(t,function(e){if(e.target.matches(".overlay, .close")){e.preventDefault();overlay.parentNode.removeChild(overlay);liercd.overlayed=false}})});var select=overlay.querySelector("select[name=connection]");for(connection in liercd.connections){var option=document.createElement("OPTION");option.setAttribute("value",connection);option.textContent=liercd.connections[connection].host;select.appendChild(option)}overlay.addEventListener("submit",function(e){e.preventDefault();var channel=overlay.querySelector("input[name=channel]").value;var conn=select.options[select.selectedIndex].value;fetch(liercd.baseurl+"/connection/"+conn,{method:"POST",body:"JOIN "+channel,credentials:"same-origin",headers:{"content-type":"application/irc","lierc-token":liercd.post_token()}}).then(function(res){overlay.parentNode.removeChild(overlay);liercd.overlayed=false;if(!res.ok)throw Error(res.statusText);return res.json()}).then(function(res){liercd.post_tokens.push(res.token)}).catch(function(e){var res=JSON.parse(e.responseText);alert("Error: "+res.error);liercd.load_token()})})}document.querySelectorAll(".join-channel").forEach(function(el){el.addEventListener("click",join_click)});document.querySelector(".add-connection").addEventListener("click",liercd.config_modal);document.querySelectorAll("#nav .nav-title").forEach(function(el){el.addEventListener("click",function(e){if(e.target.classList.contains("nav-title")||e.target.classList.contains("nav-title-text")||e.target.classList.contains("count")){e.preventDefault();el.classList.toggle("collapsed")}})});["click","touchstart"].forEach(function(type){document.querySelector("#toggle-hideevents a").addEventListener(type,function(e){e.preventDefault();liercd.focused.set_ignore_events(!liercd.focused.ignore_events);liercd.update_pref(liercd.focused.id+"-ignore-events",liercd.focused.ignore_events)});document.querySelector("#toggle-hideembeds a").addEventListener(type,function(e){e.preventDefault();liercd.focused.set_collapse_embeds(!liercd.focused.collapse_embeds);liercd.update_pref(liercd.focused.id+"-collapse-embeds",liercd.focused.collapse_embeds)});document.querySelector("#toggle-nicks").addEventListener(type,function(e){e.preventDefault();liercd.focused.set_show_nicklist(!liercd.focused.show_nicklist);liercd.update_pref(liercd.focused.id+"-show-nicklist",liercd.focused.show_nicklist)})});liercd.elem.emoji.addEventListener("click",function(e){e.preventDefault();var emoji_search=document.querySelector(".emoji-search input");if(e.target.matches("li[data-chars]")){liercd.focus_input(true);document.execCommand("insertText",false,e.target.getAttribute("data-chars"));liercd.elem.emoji.classList.remove("open");emoji_search.value="";Emoji.filter(liercd.elem.emoji,"")}if(e.target.matches("#emoji")){e.target.classList.toggle("open");if(!liercd.mobile){if(e.target.classList.contains("open")){emoji_search.value="";Emoji.filter(liercd.elem.emoji,"");emoji_search.focus()}}}});function send_submit(){var input=liercd.elem.input.querySelector(".input");var value=Unformat(input.innerHTML);if(value=="")return;input.innerHTML="";var panel=liercd.panels[input.getAttribute("data-panel-id")];var connection=liercd.connections[panel.connection];var send=[];if(value.substring(0,1)=="/"){try{send.push(commands.handle_command(panel,value.substring(1)))}catch(e){alert(e);return}}else if(panel.type=="status"){throw"Can not message a status"}else{var lines=value.split(/[\r\n]/);for(var j=0;j<lines.length;j++){var value=lines[j];if(!value)continue;var privmsg="PRIVMSG "+panel.name+" :";if(value.length+privmsg.length<510){send.push(privmsg+value)}else{var words=value.split(" ");var len=privmsg.length;var buf=[];for(var i=0;i<words.length;i++){var word=words[i];if(len+word.length>510){send.push(privmsg+buf.join(" "));len=privmsg.length+word.length;buf=[word]}else{buf.push(word);len+=word.length+1}}if(buf.length){send.push(privmsg+buf.join(" "))}}}}function sendlines(lines){if(!lines.length)return;fetch(liercd.baseurl+"/connection/"+panel.connection,{credentials:"same-origin",method:"POST",headers:{"content-type":"application/irc","lierc-token":liercd.post_token()},body:lines.shift()}).then(function(res){if(!res.ok)throw Error(res.statusText);return res.json()}).then(function(res){liercd.post_tokens.push(res.token);if(lines.length)sendlines(lines)}).catch(function(e){alert("Error: "+e);liercd.load_token()})}sendlines(send)}document.getElementById("gist-upload-form").addEventListener("submit",function(e){e.preventDefault();var form=e.target;var submit=form.querySelector("input[name=upload]");var text=form.querySelector("textarea");var ext=form.querySelector("select");var filename="files1."+ext.options[ext.selectedIndex].value;submit.setAttribute("disabled","disabled");text.setAttribute("disabled","disabled");var data={"public":false,files:{}};data["files"][filename]={content:text.value};fetch("https://api.github.com/gists",{method:"POST",body:JSON.stringify(data)}).then(function(res){if(!res.ok)throw Error(res.statusText);return res.json()}).then(function(res){submit.removeAttribute("disabled");text.removeAttribute("disabled");text.value="";liercd.focus_input(true);document.execCommand("insertText",false,res.html_url);document.getElementById("upload").classList.remove("open")}).catch(function(e){alert("I'm sorry");submit.removeAttribute("disabled");text.removeAttribute("disabled")})});document.getElementById("image-upload-form").addEventListener("submit",function(e){e.preventDefault();var submit=e.target.querySelector('input[name="upload"]');var image=e.target.querySelector('input[name="image"]');var files=image.files;if(files.length==0||!files[0].type.match(/^image/)){alert("Must select an image file");return}var fd=new FormData;fd.append("image",files[0]);var xhr=new XMLHttpRequest;xhr.open("POST","//api.imgur.com/3/image");xhr.setRequestHeader("Authorization","Client-ID 033f98700d8577c");submit.setAttribute("disabled","disabled");xhr.addEventListener("load",function(){var res=JSON.parse(xhr.responseText);liercd.focus_input(true);document.execCommand("insertText",false,res.data.link);document.getElementById("upload").classList.remove("open");image.value=null;submit.removeAttribute("disabled")});xhr.send(fd)});["touchstart","click"].forEach(function(type){document.getElementById("upload").addEventListener(type,function(e){if(e.target.matches("#upload")){e.preventDefault();e.target.classList.toggle("open")}})});["click","touchstart"].forEach(function(type){document.getElementById("help").addEventListener(type,function(e){e.preventDefault();liercd.elem.flex_wrap.classList.remove("open");var overlay=document.createElement("DIV");overlay.classList.add("overlay");var help=document.querySelector(".help").cloneNode(true);overlay.appendChild(help);liercd.elem.body.appendChild(overlay);liercd.overlayed=true;["click","touchstart"].forEach(function(type){overlay.addEventListener(type,function(e){if(!e.target.matches(".overlay, .close"))return;e.preventDefault();overlay.parentNode.removeChild(overlay);liercd.overlayed=false})})})});["click","touchstart"].forEach(function(type){document.getElementById("logout").addEventListener(type,function(e){e.preventDefault();if(!confirm("Are you sure you want to log out?"))return;fetch(liercd.baseurl+"/logout",{method:"POST",credentials:"same-origin"}).then(function(res){if(!res.ok)alert("Error!");else window.location.reload()})})});window.addEventListener("resize",function(e){if(liercd.focused){liercd.focused.scroll();liercd.focused.resize_filler()}});document.addEventListener("copy",function(e){if(liercd.overlayed)return;e.preventDefault();var selected=window.getSelection().toString().split("\n");var lines=[];var nick;for(i in selected){var line=selected[i].trim();if(line.match(/^\d\d:\d\d$/))continue;if(!nick&&line.match(/^< [^>]+>$/)){nick=line;continue}if(nick){lines.push(nick+" "+line);nick=null;continue}if(line.match(/\S/))lines.push(line)}e.clipboardData.setData("Text",lines.join("\n"))});document.addEventListener("paste",function(e){if(liercd.overlayed)return;if(document.activeElement.matches("#gist-upload-input"))return;e.preventDefault();var clipboard=e.clipboardData||e.originalEvent.clipboardData;var items=clipboard.items;for(i in items){if(items[i].type&&items[i].type.match(/^image\//)){liercd.focus_input();var blob=items[i].getAsFile();var fd=new FormData;fd.append("image",blob);var xhr=new XMLHttpRequest;xhr.open("POST","//api.imgur.com/3/image");xhr.setRequestHeader("Authorization","Client-ID 033f98700d8577c");xhr.onload=function(){var res=JSON.parse(xhr.responseText);liercd.focus_input(true);document.execCommand("insertText",false,res.data.link)};xhr.send(fd);return}}liercd.focus_input();var text=clipboard.getData("Text");document.execCommand("insertText",false,text)});["touchstart","click"].forEach(function(type){document.querySelector(".flex-wrap-left header").addEventListener(type,function(e){e.preventDefault();liercd.elem.flex_wrap.classList.toggle("open")})});document.addEventListener("input",function(e){if(e.target.matches(".emoji-search input")){var list=e.target.parentNode.previousSibling;Emoji.filter(list,e.target.value)}});document.getElementById("email-notify").addEventListener("click",function(e){e.preventDefault();this.classList.toggle("enabled");var enabled=e.target.classList.contains("enabled");liercd.update_pref("email",enabled)});liercd.elem.panel.addEventListener("click",function(e){if(!e.target.matches(".message-menu, .message-menu *"))return;var target=e.target;var toggle=target;var controls=target;var message=target;while(toggle&&!toggle.matches(".message-menu")){toggle=toggle.parentNode}while(controls&&!controls.matches(".message-controls")){controls=controls.parentNode}while(message&&!message.matches("li.message")){message=message.parentNode}var is_monospace=message.classList.contains("monospace");toggle.classList.toggle("open");if(target.matches(".message-menu")){if(toggle.classList.contains("open")){var popup=document.createElement("DIV");popup.classList.add("message-menu-popup");var list=document.createElement("UL");var privmsg=document.createElement("LI");privmsg.classList.add("message-privmsg");privmsg.textContent="Direct message";var mono=document.createElement("LI");mono.classList.add("message-monospace");mono.textContent="Monospace text ";var text=document.createTextNode(is_monospace?"off":"on");mono.appendChild(text);list.appendChild(privmsg);list.appendChild(mono);controls.classList.add("open");popup.appendChild(list);toggle.appendChild(popup)}else{controls.classList.remove("open");toggle.innerHTML=""}}else if(target.matches(".message-privmsg")){controls.classList.remove("open");toggle.innerHTML="";message.querySelector(".message-nick").click()}else if(target.matches(".message-monospace")){controls.classList.remove("open");toggle.innerHTML="";var nick=message.querySelector(".message-nick").getAttribute("data-nick");if(is_monospace){liercd.remove_monospace_nick(liercd.focused,nick)}else{liercd.add_monospace_nick(liercd.focused,nick)}}});liercd.elem.panel.addEventListener("click",function(e){if(!e.target.matches(".embed-toggle"))return;e.preventDefault();var toggle=e.target;var embed=JSON.parse(toggle.getAttribute("data-embed"));toggle.classList.toggle("hidden");if(toggle.classList.contains("hidden")){var wrap=document.querySelector(".embed-wrap[data-embed-id='"+embed.id+"']");wrap.parentNode.parentNode.removeChild(wrap.parentNode)}else{var a=toggle.previousSibling;liercd.focused.embed(a,embed,true)}});liercd.elem.topic.addEventListener("click",function(e){if(liercd.focused){if(e.target.nodeName!="A"){var elem=this;liercd.focused.scroll(function(){elem.classList.toggle("expanded")})}}});liercd.elem.panel.addEventListener("click",function(e){if(!e.target.matches(".embed-wrap[data-embed-id]:not(.open) *"))return;var p=e.target;while(p&&!p.matches(".embed-wrap[data-embed-id]")){p=p.parentNode}var id=p.getAttribute("data-embed-id");var a=document.querySelector(".embed-toggle[data-embed-id='"+id+"']");var embed=JSON.parse(a.getAttribute("data-embed"));p.classList.add("open");p.innerHTML=embed.html;var head=document.querySelector("head");p.querySelectorAll("script").forEach(function(el){var s=el.parentNode.removeChild(el);var script=document.createElement("SCRIPT");var attrs=s.attributes;for(var i=0;i<attrs.length;i++){script.setAttribute(attrs[i].name,attrs[i].value)}head.appendChild(script)})});liercd.elem.panel.addEventListener("click",function(e){if(!e.target.matches(".message-react, .message-react *"))return;var target=e.target;var react=target;var controls=target;while(react&&!react.matches(".message-react")){react=react.parentNode}while(controls&&!controls.matches(".message-controls")){controls=controls.parentNode}if(target.matches(".message-react")){react.classList.toggle("open");if(react.classList.contains("open")){var emoji=document.querySelector("#emoji .emoji-popup").cloneNode(true);react.appendChild(emoji);emoji.querySelector(".emoji-search input").focus();controls.classList.add("open")}else{var popup=react.querySelector(".emoji-popup");popup.parentNode.removeChild(popup);controls.classList.remove("open")}}if(target.matches("li[data-chars]")){var emoji=target.getAttribute("data-chars");var message=react;while(message&&!message.matches("li.message")){message=message.parentNode}var hash=message.getAttribute("data-message-hash");var panel=liercd.focused;react.classList.remove("open");controls.classList.remove("open");var popup=react.querySelector(".emoji-popup");popup.parentNode.removeChild(popup);if(!(emoji&&hash&&panel))return;fetch(liercd.baseurl+"/connection/"+panel.connection,{method:"POST",credentials:"same-origin","content-type":"application/irc",body:"PRIVMSG "+panel.name+" :"+["FACE",hash,emoji].join(" "),headers:{"lierc-token":liercd.post_token()}}).then(function(res){if(!res.ok)throw Error(res.statusText);return res.json()}).then(function(res){liercd.post_tokens.push(res.token)}).catch(function(e){var res=JSON.parse(e.responseText);alert("Error: "+res.error);liercd.load_token()})}});window.addEventListener("beforeunload",function(){if(liercd.focused){liercd.focused.update_seen();liercd.save_seen(liercd.focused,true)}});liercd.elem.panel.addEventListener("transitionend",function(e){if(e.target.matches("li.chat"))e.target.classList.remove("loading","loaded")})};var Channel=function(name){this.name=name;this.topic={value:"No topic set",user:null,time:null};this.nicks={};this.synced=true;this.mode="";this.reset_nicks=function(){this.nicks={}};this.add_nick=function(nick,mode){if(!mode)mode="";this.nicks[nick]=mode};this.set_mode=function(param){var action=param.substring(0,1);var modes=param.substring(1);for(var i=0;i<modes.length;i++){var current=this.mode;var mode=modes[i];if(action=="+"&&current.indexOf(mode)==-1)this.mode=current+mode;else if(action=="-"&&current.indexOf(mode)!=-1)this.mode=current.replace(mode,"")}};this.nick_mode=function(nick,param){var action=param.substring(0,1);var modes=param.substring(1);for(var i=0;i<modes.length;i++){var current=this.nicks[nick];var mode=modes[i];if(action=="+"&&current.indexOf(mode)==-1)this.nicks[nick]=current+mode;else if(action=="-"&&current.indexOf(mode)!=-1)this.nicks[nick]=current.replace(mode,"")}};this.contains_nick=function(nick){return nick in this.nicks};this.remove_nick=function(nick){if(nick in this.nicks){delete this.nicks[nick];return true}return false};this.rename_nick=function(old,nick){if(old in this.nicks){this.nicks[nick]=this.nicks[old];delete this.nicks[old];return true}return false}};var Panel=function(name,id,connection,mobile){var panel=this;panel.name=name;panel.id=id;panel.connection=connection.id;panel.unread=false;panel.missed=false;panel.connected=connection.connected;panel.highlighted=false;panel.type=determine_panel_type(name,connection.chantypes);panel.focused=false;panel.backlog_empty=false;panel.reactions=[];panel.monospace_nicks=[];panel.ignore_events=false;panel.collapse_embeds=false;panel.show_nicklist=false;panel.first_focus=true;panel.last_seen=null;panel.path=window.location.pathname+"#/"+connection.id+"/"+encodeURIComponent(name);panel.observers={};panel.mode="";panel.network=connection.host;panel.mobile=mobile;panel.change_name=function(name){panel.name=name;panel.update_nav()};function determine_panel_type(name,chantypes){if(name=="status")return"status";if(chantypes.indexOf(name[0])!=-1)return"channel";return"private"}panel.update_mode=function(mode){panel.mode=mode;panel.update_nav()};panel.update_nicks=function(nicks){var order=["@","+"];var sorted=Object.keys(nicks).map(function(n){return[n,n.toLowerCase()]}).sort(function(a,b){return a[1]<b[1]?-1:a[1]>b[1]?1:0}).map(function(n){return n[0]});var display_sorted=sorted.map(function(n){var pos=order.indexOf(nicks[n]);var prefix=""+(pos!=-1?pos:order.length);return[n,prefix+n.toLowerCase()]}).sort(function(a,b){return a[1]<b[1]?-1:a[1]>b[1]?1:0});var list=panel.elem.nicks;var items=list.childNodes;var l=items.length;var del=[];for(var i=0;i<l;i++){var a=items[i].childNodes[0];var nick=a.getAttribute("data-nick");if(!(nick in nicks)){del.push(items[i])}}var sorted_len=display_sorted.length;for(var i=0;i<sorted_len;i++){var nick=display_sorted[i][0];var order=display_sorted[i][1];var inserted=false;for(var j=0;j<l;j++){var item=items[j];var a=item.childNodes[0];var n=a.getAttribute("data-nick");var o=a.getAttribute("data-nick-order");if(n==nick){var text=a.textContent;var display=nicks[nick]+nick;if(text!=display){a.textContent=display;a.setAttribute("data-nick-order",order)}inserted=true;break}else if(o>order){var li=document.createElement("LI");var a=document.createElement("A");a.setAttribute("class","nick-list-nick");a.setAttribute("data-nick",nick);a.setAttribute("data-nick-order",order);a.textContent=nicks[nick]+nick;li.appendChild(a);list.insertBefore(li,item);inserted=true;break}}if(!inserted){var li=document.createElement("LI");var a=document.createElement("A");a.setAttribute("class","nick-list-nick");a.setAttribute("data-nick",nick);a.setAttribute("data-nick-order",order);a.textContent=nicks[nick]+nick;li.appendChild(a);list.appendChild(li)}}for(var i=0;i<del.length;i++){list.removeChild(del[i])}panel.keyboard.completion.completions=sorted};panel.focus=function(){if(panel.ignore_events)panel.elem.body.classList.add("hide-events");else panel.elem.body.classList.remove("hide-events");if(panel.collapse_embeds)panel.elem.body.classList.add("hide-embeds");else panel.elem.body.classList.remove("hide-embeds");if(panel.show_nicklist)panel.elem.body.classList.add("show-nicklist");else panel.elem.body.classList.remove("show-nicklist");panel.first_focus=false;panel.focused=true;panel.resize_filler();if(!panel.mobile)panel.elem.input.focus();panel.unread=false;panel.missed=false;panel.highlighted=false;panel.update_nav();panel.scroll(true);setTimeout(function(){panel.scroll(true)},10)};panel.build_nav=function(){var el=document.createElement("LI");el.setAttribute("data-panel-id",id);var name=document.createElement("A");name.classList.add("panel-name");name.textContent=panel.name;el.appendChild(name);if(panel.type=="status"){var edit=document.createElement("A");edit.classList.add("fa","fa-pencil","edit","edit-panel");el.appendChild(edit)}else{var close=document.createElement("A");close.classList.add("fa","fa-times","close-panel");el.appendChild(close)}return el};panel.update_nav=function(){panel.elem.nav.querySelector(".panel-name").textContent=panel.name;if(panel.focused){panel.elem.nav.classList.add("active");panel.elem.nav.classList.remove("unread","missed","highlighted","disconnected");if(!panel.connected)panel.elem.nav.classList.add("disconnected")}else{panel.elem.nav.classList.remove("active");if(panel.unread)panel.elem.nav.classList.add("unread");if(panel.missed)panel.elem.nav.classList.add("missed");if(panel.highlighted)panel.elem.nav.classList.add("highlighted");if(panel.connected)panel.elem.nav.classList.remove("disconnected");else panel.elem.nav.classList.add("disconnected")}var prefix=panel.name;var title=panel.network;if(panel.mode){prefix+=" (+"+panel.mode+")";title+=" (+"+panel.mode+")"}panel.elem.prefix.textContent=prefix;panel.elem.prefix.setAttribute("title",panel.network);panel.elem.nav.setAttribute("title",title);panel.elem.nav.setAttribute("data-name",panel.name)};panel.update_seen=function(){var id=panel.latest_message_id();if(id)panel.last_seen=id};panel.unfocus=function(){panel.update_seen();panel.focused=false;panel.elem.nav.classList.remove("active");panel.clear_lists();panel.backlog_empty=false};panel.remove_elems=function(){["nav","prefix","filler","topic","nicks","input","list"].forEach(function(el){if(panel.elem[el].parentNode)panel.elem[el].parentNode.removeChild(panel.elem[el])})};panel.clear_lists=function(){panel.remove_observers(panel.elem.list);var list=panel.elem.list;while(list.firstChild){list.removeChild(list.firstChild)}var nicks=panel.elem.nicks;while(nicks.firstChild){nicks.removeChild(nicks.firstChild)}};panel.prepend=function(els){var list=panel.elem.list;var height=panel.inner.getBoundingClientRect().height;var prev_time,prev_nick,prev_mono;var length=els.length;for(var i=length-1;i>=0;i--){var el=els[i];el.classList.add("loading");if(!el.matches("li.chat"))continue;var time=el.querySelector("time");if(time){if(time.innerHTML==prev_time)time.className="hidden";prev_time=time.innerHTML}if(el.classList.contains("message")){var nick=el.querySelector(".message-nick").getAttribute("data-nick");if(panel.monospace_nicks.indexOf(nick)!=-1){el.classList.add("monospace");if(!prev_mono){el.classList.add("monospace-start")}prev_mono=true}else{if(prev_mono&&els[i+1]){els[i+1].classList.add("monospace-end")}prev_mono=false}if(nick==prev_nick){el.classList.add("consecutive")}prev_nick=nick}else{if(prev_mono&&els[i+1])els[i+1].classList.add("monospace-end");prev_nick=null;prev_mono=null}}panel.scroll(function(){for(var i=0;i<els.length;i++){if(list.childNodes.length){list.insertBefore(els[i],list.childNodes[0])}else{list.appendChild(els[i])}}});requestAnimationFrame(function(){for(var i=0;i<els.length;i++){els[i].classList.add("loaded")}});var diff=panel.inner.getBoundingClientRect().height-height;panel.scroller.scrollTop+=diff;panel.resize_filler();for(var i=0;i<els.length;i++){panel.imagify(els[i],false);panel.vidify(els[i],false);panel.audify(els[i],false)}Embed.embed_all(els,panel);panel.last_seen_separator()};panel.embed=function(a,embed,manual){var li=a.parentNode;while(li.nodeName!="LI"){li=li.parentNode}var wrap=document.createElement("DIV");wrap.classList.add("embed-wrap-wrap");var inner=document.createElement("DIV");inner.classList.add("embed-wrap");inner.setAttribute("data-embed-provider",embed.provider_name.toLowerCase());inner.setAttribute("data-embed-id",embed.id);wrap.appendChild(inner);if(!manual&&panel.collapse_embeds){var toggle=a.nextSibling;while(toggle&&!toggle.classList.contains("embed-toggle")){toggle=toggle.nextSibling}if(toggle&&toggle.classList.contains("embed-toggle")){toggle.classList.add("hidden")}return}if(embed.thumbnail_url){var img=document.createElement("DIV");img.classList.add("embed-thumb");img.style.backgroundImage="url(//noembed.com/i/0/450/"+embed.thumbnail_url+")";var play=document.createElement("DIV");play.classList.add("embed-play");img.appendChild(play)}var h2=document.createElement("H2");h2.textContent=embed.title;inner.appendChild(h2);if(embed.provider_name=="Twitter"){var html=embed.html.replace(/<script[^>]+>.*<\/script>/,"");var div=document.createElement("DIV");div.innerHTML=html;div.querySelector(".twitter-tweet").classList.remove("twitter-tweet");inner.appendChild(div)}else if(embed.description){var p=document.createElement("P");p.textContent=embed.description;inner.appendChild(p)}var p=document.createElement("P");p.classList.add("embed-source");p.textContent=embed.provider_name;inner.appendChild(p);panel.scroll(function(){li.querySelector(".message-text").appendChild(wrap);panel.resize_filler()});var wrap_el=wrap;var prev=wrap_el.getBoundingClientRect().height;panel.scroller.scrollTop+=prev;var o=new MutationObserver(function(s){var cur=wrap_el.getBoundingClientRect().height;if(!panel.is_scrolled()){panel.scroller.scrollTop+=cur-prev}prev=cur});var config={childList:true,attributes:true,subtree:true,attributeFilter:["class","style"]};o.observe(wrap,config);panel.observers[embed.id]=o};panel.is_scrolled=function(){return Math.abs(panel.scroller.scrollHeight-(panel.scroller.scrollTop+panel.scroller.clientHeight))<10};panel.append=function(el){if(el===undefined)return;if(panel.focused){var id=el.getAttribute("data-message-id");if(id&&panel.elem.list.querySelectorAll('li[data-message-id="'+id+'"]').length)return;panel.scroll(function(scrolled){panel.elem.list.appendChild(el);if(el.classList.contains("chat")){var nick_el=el.querySelector("span[data-nick]");var nick=nick_el?nick_el.getAttribute("data-nick"):"";var prev=el.previousSibling;if(el.classList.contains("message")&&prev&&prev.classList.contains("message")){var prev_nick_el=prev.querySelector("span[data-nick]");var prev_nick=prev_nick_el?prev_nick_el.getAttribute("data-nick"):"";if(nick==prev_nick)el.classList.add("consecutive")}if(prev&&prev.classList.contains("chat")){var time=el.querySelector("time");var prev_time=prev.querySelector("time");if(time&&prev_time&&time.textContent==prev_time.textContent)time.classList.add("hidden")}if(el.classList.contains("message")&&panel.monospace_nicks.indexOf(nick)!=-1){el.classList.add("monospace");if(prev&&!prev.classList.contains("monospace")){el.classList.add("monospace-start")}}else{if(prev&&prev.classList.contains("monospace"))prev.classList.add("monospace-end")}if(el.classList.contains("message")){panel.imagify(el);panel.vidify(el);panel.audify(el);Embed.embed_all([el],panel)}}panel.resize_filler()})}else{el.innerHTML="";if(el.classList.contains("message")){panel.unread=true;if(el.classList.contains("highlight"))panel.highlighted=true;panel.update_nav()}else if(el.classList.contains("event")&&!panel.ignore_events){panel.missed=true;panel.update_nav()}}};panel.resize_filler=function(){if(!panel.focused)return;var scroll=panel.scroller.getBoundingClientRect().height;var chat=panel.elem.list.getBoundingClientRect().height;panel.elem.filler.style.height=Math.max(0,scroll-chat)+"px"};panel.scroll=function(cb){if(cb===true){if(panel.focused)panel.scroller.scrollTop=panel.scroller.scrollHeight;return}var scrolled=panel.is_scrolled();if(cb)cb(scrolled);if(panel.focused&&scrolled)panel.scroller.scrollTop=panel.scroller.scrollHeight};panel.set_disabled=function(bool){if(bool){panel.elem.input.setAttribute("contenteditable","false");panel.elem.input.classList.add("disabled")}else{panel.elem.input.setAttribute("contenteditable","true");panel.elem.input.classList.remove("disabled")}};panel.latest_message_id=function(){var els=panel.elem.list.querySelectorAll("li[data-message-id]");if(els.length){return parseInt(els[els.length-1].getAttribute("data-message-id"))}return null};panel.oldest_message_id=function(){var els=panel.elem.list.querySelectorAll("li[data-message-id]");if(els.length){return parseInt(els[0].getAttribute("data-message-id"))}return null};panel.update_topic=function(topic){panel.elem.topic.childNodes.forEach(function(el){panel.elem.topic.removeChild(el)});Format(topic.value).forEach(function(el){panel.elem.topic.appendChild(el)});linkify(panel.elem.topic);if(topic.user&&topic.time){var date=new Date(topic.time*1e3);panel.elem.topic.setAttribute("title","set by "+topic.user+" on "+date)}};panel.elem={input:document.createElement("DIV"),list:document.createElement("OL"),nicks:document.createElement("UL"),topic:document.createElement("P"),filler:document.createElement("DIV"),prefix:document.createElement("SPAN"),nav:panel.build_nav(),body:document.body};panel.elem.input.setAttribute("contenteditable","true");panel.elem.input.setAttribute("data-panel-id",id);panel.elem.input.classList.add("input");panel.elem.filler.classList.add("filler");panel.elem.prefix.textContent=panel.name;panel.elem.topic.textContent="No topic set";panel.scroller=document.getElementById("panel-scroll");panel.inner=document.getElementById("panel-inner-scroll");panel.prune=function(){if(panel.focused&&!panel.is_scrolled())return;var els=Array.prototype.filter.call(panel.elem.list.querySelectorAll("li.chat"),function(el){return getComputedStyle(el).display!="none"});if(els.length>200){els.slice(0,200).forEach(function(el){panel.remove_observers(el);el.parentNode.removeChild(el)})}};panel.remove_observers=function(els){els.querySelectorAll("[data-embed-id]").forEach(function(el){var id=el.getAttribute("data-embed-id");if(panel.observers[id]){panel.observers[id].disconnect();delete panel.observers[id]}})};panel.keyboard=new Keyboard(panel.elem.input);setInterval(panel.prune,1e3*60);panel.img_re=/^http[^\s]*\.(?:jpe?g|gif|png|bmp|svg)[^\/]*$/i;panel.imagify=function(elem){var links=elem.querySelectorAll("a");for(var i=links.length-1;i>=0;i--){var link=links[i];if(link.href.match(panel.img_re)){if(link.href.match(/\.gifv/))continue;if(link.href.match(/#(nsfw|hide)/))continue;var image=new Image;

image.setAttribute("title",link.href);image.onload=function(image,link){return function(e){var s=panel.scroller;var wrap=document.createElement("DIV");var a=link.cloneNode(false);var toggle=document.createElement("SPAN");a.appendChild(image);panel.scroll(function(){if(panel.collapse_embeds){toggle.setAttribute("class","image-toggle hidden");wrap.setAttribute("class","image-wrap hidden")}else{toggle.setAttribute("class","image-toggle");wrap.setAttribute("class","image-wrap")}toggle.setAttribute("aria-hidden","true");link.parentNode.insertBefore(toggle,link.nextSibling)});toggle.addEventListener("click",function(e){e.preventDefault();panel.scroll(function(){wrap.classList.toggle("hidden");toggle.classList.toggle("hidden")})});var start=panel.scroller.scrollTop;wrap.appendChild(a);link.parentNode.appendChild(wrap);var diff=panel.scroller.scrollTop-start;panel.scroller.scrollTop+=wrap.getBoundingClientRect().height-diff}}(image,link);image.src="https://noembed.com/i/0/600/"+link.href}}};panel.vid_re=/^http[^\s]*\.(?:gifv|mp4)[^\/]*$/i;panel.vidify=function(elem){var links=elem.querySelectorAll("a");for(var i=links.length-1;i>=0;i--){var link=links[i];if(link.href.match(panel.vid_re)){if(link.href.match(/i\.imgur\.com\/[^\/\.]+\.gifv/))link.href=link.href.replace(".gifv",".mp4");if(link.href.match(/http:\/\/i\.imgur\.com/))link.href=link.href.replace(/^http/,"https");var video=document.createElement("VIDEO");video.controls="controls";video.preload="metadata";video.addEventListener("loadeddata",function(video,link){return function(e){var s=panel.scroller;var wrap=document.createElement("DIV");var toggle=document.createElement("SPAN");panel.scroll(function(){if(panel.collapse_embeds){toggle.setAttribute("class","image-toggle hidden");wrap.setAttribute("class","image-wrap hidden")}else{toggle.setAttribute("class","image-toggle");wrap.setAttribute("class","image-wrap")}toggle.setAttribute("aria-hidden","true");link.parentNode.insertBefore(toggle,link.nextSibling)});toggle.addEventListener("click",function(e){e.preventDefault();panel.scroll(function(){wrap.classList.toggle("hidden");toggle.classList.toggle("hidden")})});var start=panel.scroller.scrollTop;wrap.appendChild(video);link.parentNode.appendChild(wrap);var diff=panel.scroller.scrollTop-start;panel.scroller.scrollTop+=wrap.getBoundingClientRect().height-diff}}(video,link),false);video.src=link.href;video.load()}}};panel.aud_re=/^http[^\s]*\.(?:mp3|wav|aac|m4a)[^\/]*$/i;panel.audify=function(elem){var links=elem.querySelectorAll("a");for(var i=links.length-1;i>=0;i--){var link=links[i];if(link.href.match(panel.aud_re)){var audio=document.createElement("AUDIO");audio.controls="controls";audio.addEventListener("loadeddata",function(audio,link){return function(e){var s=panel.scroller;var start=s.scrollHeight;var wrap=document.createElement("DIV");link.parentNode.appendChild(wrap);link.parentNode.removeChild(link);wrap.appendChild(link);link.innerHTML="";link.appendChild(audio);wrap.className="image-wrap";var end=s.scrollHeight;panel.scroller.scrollTop+=end-start}}(audio,link),false);audio.src=link.href;audio.load()}}};panel.react_backlog_check=function(){panel.reactions.forEach(function(reaction,i){var li=panel.elem.list.querySelector('li[data-message-hash="'+reaction[1]+'"]');if(li.length){panel.handle_reaction.apply(panel,reaction);panel.reactions.slice(i,1)}})};panel.handle_reaction=function(from,hash,reaction){if(!hash){console.log(from,hash,reaction);return}var li=panel.elem.list.querySelector('li[data-message-hash="'+hash+'"]');if(li){panel.scroll(function(scroll){var reactions=li.querySelector(".reactions");if(!reactions){reactions=document.createElement("DIV");reactions.classList.add("reactions");li.appendChild(reactions)}var span=document.createElement("SPAN");span.textContent=reaction;span.setAttribute("title",from);if(reactions.firstChild){reactions.insertBefore(span,reactions.firstChild)}else{reactions.appendChild(span)}if(scroll)panel.resize_filler()})}else{panel.reactions.push([from,hash,reaction])}};panel.set_loading=function(on){if(on){panel.elem.list.classList.add("loading")}else{panel.elem.list.classList.remove("loading")}};panel.set_collapse_embeds=function(bool){panel.scroll(function(){if(panel.focused){if(bool){panel.elem.body.classList.add("hide-embeds");panel.elem.list.querySelectorAll(".embed-toggle:not(.hidden)").forEach(function(el){el.click()});panel.elem.list.querySelectorAll(".image-toggle:not(.hidden)").forEach(function(el){el.click()})}else{panel.elem.body.classList.remove("hide-embeds");panel.elem.list.querySelectorAll(".embed-toggle.hidden").forEach(function(el){el.click()});panel.elem.list.querySelectorAll(".image-toggle.hidden").forEach(function(el){el.click()})}}panel.collapse_embeds=bool;if(panel.focused&&bool)panel.resize_filler()})};panel.set_ignore_events=function(bool){panel.scroll(function(){if(panel.focused){if(bool)panel.elem.body.classList.add("hide-events");else panel.elem.body.classList.remove("hide-events")}panel.ignore_events=bool;if(panel.focused&&bool)panel.resize_filler()})};panel.set_connected=function(bool,message){panel.connected=bool;panel.update_nav()};panel.set_show_nicklist=function(bool){panel.scroll(function(){if(bool)panel.elem.body.classList.add("show-nicklist");else panel.elem.body.classList.remove("show-nicklist");panel.show_nicklist=bool;panel.resize_filler()})};panel.add_monospace_nick=function(nick){if(panel.monospace_nicks.indexOf(nick)==-1){panel.monospace_nicks.push(nick)}panel.scroll(function(){panel.elem.list.querySelectorAll('li.message .message-nick[data-nick="'+nick+'"]').forEach(function(line){line.parentNode.parentNode.classList.add("monospace")})})};panel.remove_monospace_nick=function(nick){var i=panel.monospace_nicks.indexOf(nick);if(i!=-1){panel.monospace_nicks.splice(i,1)}panel.scroll(function(){panel.elem.list.querySelectorAll('li.message .message-nick[data-nick="'+nick+'"]').forEach(function(line){line.parentNode.parentNode.classList.remove("monospace","monospace-start","monospace-end")})})};panel.last_seen_separator=function(){if(panel.last_seen){var msg=panel.elem.list.querySelector('li[data-message-id="'+panel.last_seen+'"]');if(!msg)return;var next_visible;while(msg.nextSibling){if(getComputedStyle(msg.nextSibling).display!="none"){next_visible=msg.nextSibling;break}msg=msg.nextSibling}if(next_visible){panel.scroll(function(){var sep=panel.elem.list.querySelector(".last-read");if(sep){sep.parentNode.removeChild(sep)}sep=document.createElement("DIV");sep.classList.add("last-read");msg.parentNode.insertBefore(sep,msg.nextSibling);if(msg.classList.contains("monospace")){msg.classList.add("monospace-end")}})}}}};var Emoji={names:{},data:[],regex:new RegExp,list:document.querySelector("#emoji ul")};Emoji.filter=function(list,text){var items=list.querySelectorAll("li");var len=items.length;if(!text){for(var i=0;i<len;i++){items[i].style.display="inline-block"}return}var t=text.toLowerCase();for(var i=0;i<len;i++){if(items[i].getAttribute("data-keywords").indexOf(t)!=-1){items[i].style.display="inline-block"}else if(items[i].getAttribute("data-name").indexOf(t)!=-1){items[i].style.display="inline-block"}else{items[i].style.display="none"}}};Emoji.load=function(){var safari=navigator.userAgent.indexOf("Safari")!=-1&&navigator.userAgent.indexOf("Chrome")==-1;fetch("/static/emoji-data.json").then(function(res){if(!res.ok)throw Error(res.statusText);return res.json()}).then(function(res){var codepoints=[];var length=safari?Math.min(res.length,100):res.length;for(var i=0;i<length;i++){var annotations=res[i]["annotations"]||[];Emoji.data.push({chars:res[i]["chars"],keywords:annotations.join(" ").toLowerCase(),name:res[i]["name"]});Emoji.names[res[i]["chars"]]=res[i]["name"];var surrogate="";for(var j=0;j<res[i]["codes"].length;j++){if(res[i]["codes"][j].length>4){var C=parseInt("0x"+res[i]["codes"][j]);var H=Math.floor((C-65536)/1024)+55296;var L=(C-65536)%1024+56320;surrogate+="\\u"+H.toString(16)+"\\u"+L.toString(16)}else{surrogate+="\\u"+res[i]["codes"][j]}}codepoints.push(surrogate)}var sorted=codepoints.sort(function(a,b){if(a.length>b.length)return-1;else if(a.length==b.length)return 0;else return 1});Emoji.regex=new RegExp("("+sorted.join("|")+")","g");for(var i=0;i<Emoji.data.length;i++){var li=document.createElement("LI");li.setAttribute("data-chars",Emoji.data[i]["chars"]);li.setAttribute("data-keywords",Emoji.data[i]["keywords"].toLowerCase());li.setAttribute("data-name",Emoji.data[i]["name"].toLowerCase());li.setAttribute("title",Emoji.data[i]["name"]);li.textContent=Emoji.data[i]["chars"];Emoji.list.appendChild(li)}})};Emoji.load();var Render=function(message,force_raw){if(force_raw)return raw(message);switch(String(message.Command)){case"NICK":var old=message.Prefix.Name;var nick=message.Params[0];message.Prefix.Name=nick;return append(make("event",message),[make_text(old+" is now known as "),make_nick(message),timestamp(message)]);case"PART":var nick=message.Prefix.Name;var name=message.Params[0];var msg=message.Params[1];return append(make("event",message),[make_nick(message),make_text(" has left"+(msg?" ("+msg+")":"")),timestamp(message)]);case"MODE":if(message.Prefix.Nick==message.Params[0]){return raw(message)}else{var channel=message.Params[0];return append(make("event",message),[make_text(message.Params.slice(1).join(" ")),make_text(" by "+message.Prefix.Name),timestamp(message)])}case"QUIT":var nick=message.Prefix.Name;var msg=message.Params[0];return append(make("event",message),[make_nick(message),make_text(" has quit"+(msg?" ("+msg+")":"")),timestamp(message)]);case"JOIN":var name=message.Params[0];var nick=message.Prefix.Name;return append(make("event",message),[make_nick(message),make_text(" has joined the channel"),timestamp(message)]);case"332":var name=message.Params[1];var text=message.Params[2];var span=append(make_text(),[make_text("Topic: ")].concat(Format(text)));linkify(span);return append(make("event",message),[span]);case"TOPIC":var nick=message.Prefix.Name;var name=message.Params[0];var text=message.Params[1];var span=append(make_text(),[make_nick(message),make_text(" changed the topic: ")].concat(Format(text)));linkify(span);return append(make("event",message),[span,timestamp(message)]);case"PRIVMSG":var nick=message.Prefix.Name;if(message.Params.length<2)return;var name=message.Params[0];var text=message.Params[1];if(!name.length||!text.length)return raw(message);var from=make_nick(message);var color=string_to_color(message.Prefix.User||nick);var msg=make_text();msg.setAttribute("class","message-text");from.style.color=color;if(text.substring(0,1)==""){if(text.substring(1,7)=="ACTION"){from.textContent="* "+nick+" ";append(msg,Format(text.substring(8,text.length-1)))}else{return}}else{from.textContent="< "+nick+"> ";append(msg,Format(text))}linkify(msg);var hash=md5(message.Raw);var li=make("message",message);li.setAttribute("data-message-hash",hash);return append(li,[flex(from,msg,timestamp(message)),controls(message)]);case"NOTICE":var name=message.Prefix.Name;var text=message.Params[1];var chan=make_text(name);chan.setAttribute("class","channel");var span=append(make_text(" "),Format(text));linkify(span);return append(make("raw notice",message),[chan,span]);case"CONNECT":if(message.Params.length!=1)return;var host=message.Prefix.Name;var span=make_text(host+" ");span.setAttribute("class","host");return append(make("raw notice",message),[span,message.Params[0]]);case"DISCONNECT":if(message.Params.length!=1)return;var host=message.Prefix.Name;var span=make_text(host+" ");span.setAttribute("class","host");return append(make("raw notice",message),[span,message.Params[0]]);default:return raw(message)}function append(node,children){for(var i=0;i<children.length;i++){if(typeof children[i]==="string"){node.appendChild(document.createTextNode(children[i]))}else{try{node.appendChild(children[i])}catch(e){console.log(e,children[i])}}}return node}function make_text(text){var el=document.createElement("SPAN");if(text)el.textContent=text;return el}function make_nick(message){var prefix=message.Prefix.Name+"!"+message.Prefix.User+"@"+message.Prefix.Server;var el=document.createElement("SPAN");el.setAttribute("data-nick",message.Prefix.Name);el.setAttribute("title",prefix);el.classList.add("message-nick");el.textContent=message.Prefix.Name;return el}function raw(message){var text="";if(message.Command.match(/^[45][0-9][0-9]$/))text=message.Params.join(" ");else if(message.Command.match(/^[0-9][0-9][0-9]$/))text=message.Params.slice(1).join(" ");else text=[message.Prefix.Name,message.Command].concat(message.Params).join(" ");var raw=make("raw",message);raw.textContent=text;return raw}function timestamp(message){var date=new Date(message.Time*1e3);var h=String(date.getHours());if(h.length<2)h="0"+h;var m=String(date.getMinutes());if(m.length<2)m="0"+m;var time=document.createElement("TIME");time.setAttribute("data-time",message.Time);time.setAttribute("title",date.toString());time.textContent=h+":"+m;return time}function controls(message){var controls=document.createElement("DIV");controls.classList.add("message-controls");if(!message.Prefix.Self){var react=document.createElement("DIV");react.classList.add("message-react");controls.appendChild(react)}var menu=document.createElement("DIV");menu.classList.add("message-menu");controls.appendChild(menu);return controls}function make(type,message){var li=document.createElement("LI");li.classList.add("chat",message.Command.toLowerCase());var classes=type.split(" ");for(var i=0;i<classes.length;i++){li.classList.add(classes[i])}if(message.Prefix.Self)li.classList.add("self");if(message.Highlight)li.classList.add("highlight");if(message.Search)li.classList.add("search");if(message.Id)li.setAttribute("data-message-id",message.Id);return li}function flex(){var wrap=document.createElement("DIV");wrap.setAttribute("class","message-flex");for(var i=0;i<arguments.length;i++){wrap.appendChild(arguments[i])}return wrap}function string_to_color(str){var colors=["MediumVioletRed","PaleVioletRed","DeepPink","HotPink","Red","DarkRed","FireBrick","Crimson","IndianRed","Orange","DarkOrange","Coral","Tomato","OrangeRed","Maroon","Brown","Sienna","SaddleBrown","Chocolate","Peru","DarkGoldenrod","Goldenrod","MidnightBlue","MediumBlue","Blue","RoyalBlue","SteelBlue","CornflowerBlue","DodgerBlue","DeepSkyBlue","LightSkyBlue","SkyBlue","MediumSlateBlue","SlateBlue","DarkSlateBlue","Indigo","Purple","DarkMagenta","DarkOrchid","DarkViolet"];var c=0;var m=colors.length;for(var i=0;i<str.length;i++){c=((c<<5)+str.charCodeAt(i))%m}return colors[c]}};var url_re=/(https?:\/\/[^\s<"]*)/gi;function linkify(elem){var children=elem.childNodes;var length=children.length;var tmp=document.createElement("SPAN");for(var i=0;i<length;i++){var node=children[i];if(node.nodeName=="A"){continue}else if(node.nodeName!="#text"){linkify(node);continue}if(node.nodeValue===null){continue}if(node.nodeValue.match(url_re)){var span=document.createElement("SPAN");tmp.textContent=node.nodeValue;var escaped=tmp.innerHTML;span.innerHTML=escaped.replace(url_re,'<a href="$1" target="_blank" rel="noreferrer">$1</a>');node.parentNode.replaceChild(span,node);node=span}if(Emoji.regex.test(node.nodeValue)){var chars=node.nodeValue.match(Emoji.regex);var span=document.createElement("SPAN");tmp.textContent=node.nodeValue;var escaped=tmp.innerHTML;for(var j=0;j<chars.length;j++){var title=Emoji.names[chars[j]];escaped=escaped.replace(new RegExp(chars[j],"g"),'<span title="'+title+'">'+chars[j]+"</span>")}span.innerHTML=escaped;node.parentNode.replaceChild(span,node)}}}var Connection=function(id,host,nick){var conn=this;conn.id=id;conn.host=host;conn.nick=nick;conn.connected=false;conn.channels=[];conn.isupport={};conn.prefix=[["v","+"],["o","@"],["h","%"]];conn.chantypes=["#","&"];var listeners={};conn.on=function(name,func){if(!listeners[name])listeners[name]=[];listeners[name].push(func)};fire=function(name){if(listeners[name]){var data=Array.prototype.slice.call(arguments,1);listeners[name].forEach(function(listener){listener.apply(undefined,data)})}};conn.remove_channel=function(name){var i=conn.channels.indexOf(name);if(i!=-1){conn.channels.splice(i,1);return true}return false};conn.nick_mode=function(nick){var first=nick.slice(0,1);for(var i=0;i<conn.prefix.length;i++){if(first==conn.prefix[i][1]){return[nick.slice(1),conn.prefix[i][0]]}}return[nick,""]};conn.nicks=function(channel){var ret={};for(nick in channel.nicks){var modes=channel.nicks[nick];ret[nick]="";for(var i=0;i<conn.prefix.length;i++){if(modes.indexOf(conn.prefix[i][0])!=-1){ret[nick]=conn.prefix[i][1]+ret[nick]}}}return ret};conn.on_message=function(message){switch(String(message.Command)){case"CONNECT":fire("connect",conn.id,message);fire("status",conn.id,message);break;case"DISCONNECT":fire("disconnect",conn.id,message);fire("status",conn.id,message);break;case"001":conn.nick=message.Params[0];fire("status:raw",conn.id,message);break;case"005":var parts=message.Params[1].split(" ");for(var i=0;i<parts.length;i++){if(parts[i].indexOf("=")!=-1){var kv=parts[i].split("=",2);conn.isupport[kv[0]]=kv[1];if(kv[0]=="PREFIX"){var match=kv[1].match(/\(([^\)]+)\)(.+)/);if(match){var modes=match[1].split("");var prefixes=match[2].split("");conn.prefix=[];for(var j=0;j<modes.length;j++){conn.prefix.push([modes[j],prefixes[j]])}}}else if(kv[0]=="CHANTYPES"){conn.chantypes=kv[1].split("")}}else{conn.isupport[parts[i]]=true}}break;case"NICK":var old=message.Prefix.Name;var nick=message.Params[0];if(old==conn.nick){conn.nick=nick;conn.channels.forEach(function(channel){channel.rename_nick(old,nick);fire("status:raw",conn.id,message);fire("channel:msg",conn.id,channel.name,message);fire("channel:nicks",conn.id,channel.name,conn.nicks(channel))})}else{conn.channels.forEach(function(channel){if(channel.rename_nick(old,nick)){fire("channel:msg",conn.id,channel.name,message);fire("channel:nicks",conn.id,channel.name,conn.nicks(channel))}})}break;case"PART":var nick=message.Prefix.Name;var name=message.Params[0];var msg=message.Params[1];var del=true;for(var i=0;i<conn.channels;i++){if(conn.channels[i].contains_nick(nick)){del=false;break}}var channel=conn.channel(name);if(channel){if(nick==conn.nick){conn.remove_channel(name);fire("channel:close",conn.id,name)}else{channel.remove_nick(nick);fire("channel:msg",conn.id,name,message);fire("channel:nicks",conn.id,name,conn.nicks(channel))}};break;case"QUIT":var nick=message.Prefix.Name;var msg=message.Params[0];conn.channels.forEach(function(channel){if(channel.remove_nick(nick)){fire("channel:msg",conn.id,channel.name,message);fire("channel:nicks",conn.id,channel.name,conn.nicks(channel))}});break;case"JOIN":var name=message.Params[0];var nick=message.Prefix.Name;if(nick==conn.nick){var channel=new Channel(name);conn.channels.push(channel);fire("channel:new",conn.id,name,message)}else{var channel=conn.channel(name);if(channel){channel.add_nick(nick);fire("channel:msg",conn.id,name,message);fire("channel:nicks",conn.id,name,conn.nicks(channel))}}break;case"324":var name=message.Params[0];var channel=conn.channel(name);if(channel){channel.mode=message.Params[1].substring(1);fire("channel:mode",conn.id,name,channel.mode)}break;case"MODE":if(message.Prefix.Name==message.Params[0]){}else{var name=message.Params[0];var channel=conn.channel(name);if(channel){if(message.Params[1].match(/[+-][voh]/)){channel.nick_mode(message.Params[2],message.Params[1]);fire("channel:nicks",conn.id,name,conn.nicks(channel))}else{channel.set_mode(message.Params[1]);fire("channel:mode",conn.id,name,channel.mode)}fire("channel:msg",conn.id,name,message)}}break;case"332":var name=message.Params[1];var topic=message.Params[2];var channel=conn.channel(name);if(channel){channel.topic.value=topic;fire("channel:topic",conn.id,name,channel.topic)}break;case"333":var name=message.Params[1];var channel=conn.channel(name);if(channel){channel.topic.user=message.Params[2];channel.topic.time=message.Params[3];fire("channel:topic",conn.id,name,channel.topic)}break;case"TOPIC":var nick=message.Prefix.Name;var name=message.Params[0];var text=message.Params[1];var channel=conn.channel(name);if(channel){channel.topic.value=text;channel.topic.time=parseInt((new Date).getTime()/1e3);channel.topic.user=nick;fire("channel:msg",conn.id,name,message);fire("channel:topic",conn.id,name,channel.topic)}break;case"353":var name=message.Params[2];var nicks=message.Params[3].split(/\s+/);var channel=conn.channel(name);if(channel){if(channel.synced){channel.reset_nicks();channel.synced=false}for(i in nicks){if(nicks[i])var nick_mode=conn.nick_mode(nicks[i]);channel.add_nick(nick_mode[0],nick_mode[1])}}break;case"366":var name=message.Params[1];var channel=conn.channel(name);if(channel){channel.synced=true;fire("channel:nicks",conn.id,name,conn.nicks(channel))}break;case"PRIVMSG":var nick=message.Prefix.Name;var name=message.Params[0];var text=message.Params[1];var priv=conn.chantypes.indexOf(name[0])==-1;var type="msg";if(text.substring(0,5)==""+"FACE")type="react";if(name==conn.nick&&priv)fire("private:"+type,conn.id,nick,message);else if(priv)fire("private:"+type,conn.id,name,message);else if(conn.channel(name))fire("channel:"+type,conn.id,name,message);break;case"PING":break;case"PONG":break;default:fire("status",conn.id,message)}};conn.channel=function(name){name=name.toLowerCase();for(var i=0;i<conn.channels.length;i++){if(conn.channels[i].name.toLowerCase()==name){return conn.channels[i]}}return false}};var Commands=function(liercd){var liercd=liercd;var commands=this;var handlers={};function add_command(name,aliases,handler){handlers[name]=handler;aliases.forEach(function(alias){handlers[alias]=handler})}add_command("help",["h"],function(panel,line){});add_command("join",["j"],function(panel,line){var parts=["JOIN",line];return parts.join(" ")});add_command("nick",[],function(panel,line){var parts=["NICK",line];return parts.join(" ")});add_command("mode",[],function(panel,line){var parts=["MODE",panel.name];if(line){parts.push(line)}return parts.join(" ")});add_command("last",["lastlog","l"],function(panel,line){if(panel.type=="status"){throw"Can not search on a status panel."}if(!line){throw"Search text required"}liercd.search_panel(panel,line)});add_command("clear",[],function(panel){panel.backlog_empty=true;panel.remove_observers(panel.elem.list);panel.elem.list.get(0).innerHTML=""});add_command("bustin",["bust"],function(panel){var url=":https://www.youtube.com/watch?v=0tdyU_gW6WE";return["PRIVMSG",panel.name,url].join(" ")});add_command("trim",["prune"],function(panel){panel.prune()});add_command("part",["close","wc"],function(panel,line){if(panel.type=="status"){throw"Can not close status panel."}if(panel.type=="private"){liercd.remove_panel(panel.id);return}var parts=["PART",panel.name];if(line)parts.push(":"+line);return parts.join(" ")});add_command("who",[],function(panel,line){var parts=["WHO",":"+line];return parts.join(" ")});add_command("whois",[],function(panel,line){var parts=["WHOIS",":"+line];return parts.join(" ")});add_command("names",["n"],function(panel,line){var parts=["NAMES"];if(!line){parts.push(":"+panel.name)}else{parts.push(":"+line)}return parts.join(" ")});add_command("say",[""],function(panel,line){return["PRIVMSG",panel.name,":"+line].join(" ")});add_command("query",["q","msg"],function(panel,line){var args=line.split(" ",1);var rest=line.substring(args[0].length).trim();var parts=["PRIVMSG",args[0]];if(rest)parts.push(":"+rest);return parts.join(" ")});add_command("me",[],function(panel,line){var parts=["PRIVMSG",panel.name];parts.push(":"+""+"ACTION "+line);return parts.join(" ")});add_command("topic",["t"],function(panel,line){if(panel.type!="channel"){throw"TOPIC only works for channels"}var parts=["TOPIC",panel.name];if(line)parts.push(":"+line);return parts.join(" ")});add_command("quote",["raw"],function(panel,line){return line});commands.handle_command=function(panel,line){var parts=line.split(" ",1);var command=parts[0].toLowerCase();if(command in handlers){var rest=line.substring(command.length);return handlers[command](panel,rest.trim())}throw"Unknown command "+parts[0]}};var Keyboard=function(element){var keyboard=this;var BOLD=66;var ITALIC=73;var UNDERLINE=85;var TAB=9;keyboard.el=element;keyboard.completion=new Completion(element);keyboard.focused=false;var osx=window.navigator.userAgent.match(/Macintosh/);keyboard.keydown=function(e,mods){if(!osx&&mods["ctrl"]){if(e.which==BOLD){e.preventDefault();document.execCommand("bold");return}if(e.which==ITALIC){e.preventDefault();document.execCommand("italic");return}if(e.which==UNDERLINE){e.preventDefault();document.execCommand("underline");return}}if(e.which==TAB&&!mods["ctrl"]){e.preventDefault();keyboard.completion.complete();return}keyboard.completion.stop()};keyboard.blur=function(){keyboard.focused=false};keyboard.focus=function(){keyboard.focused=true};keyboard.el.addEventListener("blur",keyboard.blur);keyboard.el.addEventListener("focus",keyboard.focus)};if(!("forEach"in NodeList)){NodeList.prototype.forEach=Array.prototype.forEach}var Liercd=function(url,user){var liercd=this;liercd.user=user;liercd.baseurl=url;liercd.stream;liercd.connections={};liercd.filling_backlog=false;liercd.overlayed=false;liercd.sorting=[];liercd.last_seen={};liercd.missed={};liercd.panels={};liercd.focused=null;liercd.last_panel_id=null;liercd.window_focused=true;liercd.default_panel=null;liercd.default_focused=false;liercd.prefs={};liercd.touchstart="ontouchstart"in document.documentElement;liercd.mobile=detect_mobile();liercd.post_tokens=[];liercd.elem={panel:document.getElementById("panel"),nav:document.getElementById("nav"),status:document.getElementById("status"),privates:document.getElementById("privates"),channels:document.getElementById("channels"),input:document.getElementById("input"),topic:document.getElementById("topic"),filler:document.getElementById("filler"),prefix:document.getElementById("prefix"),scroll:document.getElementById("panel-scroll"),title:document.getElementsByTagName("title")[0],nicks:document.getElementById("nicks"),body:document.body,audio:new Audio("/static/ent_communicator1.mp3"),emoji:document.getElementById("emoji"),switcher:document.getElementById("switcher-wrap"),panel_name:document.getElementById("panel-name"),flex_wrap:document.querySelector(".flex-wrap"),reconnect:document.getElementById("reconnect-status")};if(!liercd.mobile){document.querySelectorAll(".sortable").forEach(function(el){Sortable.create(el,{delay:0,onSort:function(e){liercd.save_channel_order()}})})}function panel_id(name,connection){return[connection,name.toLowerCase()].join("-")}liercd.set_connected=function(conn_id,status,message){var connection=liercd.connections[conn_id];connection.connected=status;for(id in liercd.panels){var panel=liercd.panels[id];if(panel.connection==conn_id){panel.set_connected(status,message)}}};liercd.setup_connection=function(id,host,nick){if(liercd.connections[id])return;var connection=new Connection(id,host);liercd.connections[id]=connection;var panel=liercd.add_panel("status",connection.id);panel.change_name(host);panel.update_topic({value:"status."});connection.on("channel:new",function(conn,channel,message){liercd.add_panel(channel,conn,"Id"in message)});connection.on("private:msg",function(conn,nick,message){var panel=liercd.add_panel(nick,conn,false);var connection=liercd.connections[conn];var from=message.Prefix.Name!=connection.nick;panel.append(Render(message));if(from&&(!liercd.is_focused(panel)||!panel.is_scrolled()))liercd.elem.audio.play()});connection.on("channel:msg",function(conn,channel,message){var panel=liercd.get_panel(channel,conn);var html=Render(message);if(html){panel.append(html);if(message.Highlight&&(!liercd.is_focused(panel)||!panel.is_scrolled()))liercd.elem.audio.play()}});connection.on("channel:react",function(conn,channel,message){var panel=liercd.get_panel(channel,conn);var parts=message.Params[1].split(" ");panel.handle_reaction(message.Prefix.Name,parts[1],parts[2])});connection.on("private:react",function(conn,nick,message){var panel=liercd.get_panel(nick,conn);var parts=message.Params[1].split(" ");panel.handle_reaction(message.Prefix.Name,parts[1],parts[2])});connection.on("channel:nicks",function(conn,channel,nicks){var panel=liercd.get_panel(channel,conn);if(panel.focused)panel.update_nicks(nicks)});connection.on("channel:mode",function(conn,channel,mode){var panel=liercd.get_panel(channel,conn);panel.update_mode(mode)});connection.on("channel:close",function(conn,channel){liercd.remove_panel(panel_id(channel,conn))});connection.on("status:raw",function(conn,message){var panel=liercd.get_panel("status",conn);panel.append(Render(message,true))});connection.on("status",function(conn,message){var panel=liercd.get_panel("status",conn);panel.append(Render(message))});connection.on("connect",function(conn,message){liercd.set_connected(conn,true,message.Params[0])});connection.on("disconnect",function(conn,message){liercd.set_connected(conn,false,message.Params[0])});connection.on("channel:topic",function(conn,channel,topic){var panel=liercd.get_panel(channel,conn);panel.update_topic(topic)})};liercd.is_focused=function(panel){return liercd.window_focused&&liercd.focused&&liercd.focused.id==panel.id};liercd.find_default_panel=function(){var parts=window.location.hash.split("/").slice(1);if(parts.length==2){return panel_id(decodeURIComponent(parts[1]),parts[0])}else if(liercd.sorting.length){return liercd.sorting[0]}return null};liercd.init=function(){liercd.default_panel=liercd.find_default_panel();fetch(liercd.baseurl+"/connection",{credentials:"same-origin"}).then(function(res){return res.json()}).then(function(configs){if(!configs.length)liercd.config_modal();configs.forEach(function(conn){var conn_id=conn.Id;var host=conn.Config.Host;var nick=conn.Nick;liercd.setup_connection(conn_id,host,nick)});if(liercd.stream)liercd.stream.destroy();liercd.connect()}).catch(function(e){console.log(e)})};liercd.add_recent_privates=function(){fetch(liercd.baseurl+"/privates",{credentials:"same-origin"}).then(function(res){if(!res.ok)throw Error(res.statusText);return res.json()}).then(function(privates){privates.forEach(function(priv){liercd.add_panel(priv.nick,priv.connection,false)})}).catch(function(e){console.log(e)})};liercd.connect=function(){var stream=new Stream(liercd.baseurl);stream.on("message",function(e){var conn_id=e.ConnectionId;var message=e.Message;if(e.MessageId)message.Id=e.MessageId;message.Highlight=e.Highlight;if(liercd.connections[conn_id]){liercd.connections[conn_id].on_message(message)}});stream.on("create_connection",function(e){var conn_id=e.ConnectionId;var message=e.Message;var nick=message.Params[0];var host=message.Params[1];liercd.setup_connection(conn_id,host,nick)});stream.on("delete_connection",function(e){var conn_id=e.ConnectionId;for(id in liercd.panels){var panel=liercd.panels[id];if(panel.connection==conn_id){liercd.remove_panel(id)}}delete liercd.connections[conn_id]});stream.on("close",function(e){for(id in liercd.panels){liercd.panels[id].set_disabled(true)}if(liercd.focused){liercd.focused.scroll(function(){liercd.elem.body.classList.add("disconnected")})}else{liercd.elem.body.classList.add("disconnected")}});stream.on("reconnect-status",function(text){if(liercd.focused){liercd.focused.scroll(function(){liercd.elem.reconnect.textContent=text})}else{liercd.elem.reconnect.textContent=text}});stream.on("open",function(e){liercd.elem.body.classList.remove("disconnected");if(liercd.focused){if(stream.last_id){liercd.fill_missed(stream.last_id)}}for(var id in liercd.panels){liercd.panels[id].set_disabled(false);if(!liercd.focused||id!=liercd.focused.id){liercd.panels[id].clear_lists()}}});liercd.sync_missed();liercd.add_recent_privates();liercd.stream=stream};liercd.get_panel=function(name,connection){var id=panel_id(name,connection);return liercd.panels[id]};liercd.remove_panel=function(id){if(!liercd.panels[id])return;var focused=id==liercd.focused.id;

liercd.panels[id].remove_elems();delete liercd.panels[id];if(focused&&liercd.last_panel_id){liercd.focus_panel(liercd.last_panel_id)}liercd.update_nav_counts()};liercd.update_nav_counts=function(){liercd.elem.status.previousSibling.previousSibling.querySelector(".count").textContent=liercd.elem.status.querySelectorAll("li").length;liercd.elem.privates.previousSibling.previousSibling.querySelector(".count").textContent=liercd.elem.privates.querySelectorAll("li").length;liercd.elem.channels.previousSibling.previousSibling.querySelector(".count").textContent=liercd.elem.channels.querySelectorAll("li").length};liercd.add_panel=function(name,connection,focus){var id=panel_id(name,connection);if(liercd.panels[id])return liercd.panels[id];if(!liercd.connections[connection]){console.log("Connection does not exist",connection);throw"Connection does not exist"}var conn=liercd.connections[connection];var panel=new Panel(name,id,conn,liercd.mobile);if(liercd.last_seen[panel.id])panel.last_seen=liercd.last_seen[panel.id];panel.update_nav();liercd.panels[id]=panel;if(panel.type=="status")liercd.elem.status.append(panel.elem.nav);else if(panel.type=="private")liercd.elem.privates.append(panel.elem.nav);else liercd.insert_sorted_nav(panel);liercd.update_nav_counts();if(panel.type=="channel")liercd.ignore_events_pref(panel);liercd.collapse_embeds_pref(panel);liercd.monospace_nicks_pref(panel);panel.elem.nav.addEventListener("click",function(e){e.preventDefault();liercd.elem.flex_wrap.classList.remove("open");var id=this.getAttribute("data-panel-id");var panel=liercd.panels[id];if(e.target.classList.contains("close-panel")){if(panel.type=="channel")liercd.part_channel(panel.name,panel.connection);else if(panel.type=="status")liercd.delete_connection(panel.connection);else liercd.remove_panel(id)}else if(e.target.classList.contains("edit-panel")){fetch(liercd.baseurl+"/connection/"+panel.connection,{credentials:"same-origin"}).then(function(res){if(!res.ok)throw Error(res.statusText);return res.json()}).then(function(res){liercd.config_modal(null,res)}).catch(function(e){alert("I'm sorry: "+e)})}else{liercd.focus_panel(id)}});if(focus===true||!liercd.focused){liercd.focus_panel(id)}else if(liercd.default_panel&&id==liercd.default_panel){liercd.default_panel=null;liercd.default_focused=true;liercd.focus_panel(id)}else if(!liercd.default_focused&&panel.type=="channel"&&liercd.channel_panels()==1){liercd.focus_panel(id)}if(!panel.focused&&liercd.missed[panel.id])liercd.apply_missed(panel,liercd.missed[panel.id]);delete liercd.missed[panel.id];return liercd.panels[id]};liercd.apply_missed=function(panel,missed){if(missed.messages){panel.unread=true;if(panel.type=="private")panel.highlighted=true;panel.update_nav()}else if(missed.events){panel.missed=true;panel.update_nav()}};liercd.post_token=function(){var token=liercd.post_tokens.pop();if(!token){alert("No post tokens, tell Lee!");throw Error("No tokens")}return token};liercd.part_channel=function(name,connection){if(!confirm("Are you sure you want to leave "+name+"?"))return;var headers=new Headers;headers.append("lierc-token",liercd.post_token());headers.append("content-type","application/irc");fetch(liercd.baseurl+"/connection/"+connection,{credentials:"same-origin",method:"POST",body:"PART "+name,headers:headers}).then(function(res){if(!res.ok)throw Error(res.statusText);return res.json()}).then(function(res){liercd.remove_panel(panel_id(name,connection));liercd.post_tokens.push(res.token)}).catch(function(e){alert("Error: "+e);liercd.load_token()})};liercd.delete_connection=function(connection){if(!confirm("Are you sure you want to remove this connection?"))return;fetch(liercd.baseurl+"/connection/"+connection,{credentials:"same-origin",method:"DELETE"}).then(function(res){if(!res.ok)throw Error(res.statusText);return res.json()}).catch(function(e){alert(res)})};liercd.channel_panels=function(){var panels=0;for(id in liercd.panels){if(liercd.panels[id].type=="channel")panels++}return panels};liercd.insert_sorted_nav=function(panel){var index=liercd.sorting.indexOf(panel.id);if(index==-1){liercd.elem.channels.appendChild(panel.elem.nav);liercd.save_channel_order();return}var items=liercd.elem.channels.childNodes;for(var i=0;i<items.length;i++){var id=items[i].getAttribute("data-panel-id");if(index<liercd.sorting.indexOf(id)){liercd.elem.channels.insertBefore(panel.elem.nav,items[i]);return}}liercd.elem.channels.appendChild(panel.elem.nav)};liercd.fill_missed=function(start){fetch(liercd.baseurl+"/log/"+start,{credentials:"same-origin"}).then(function(res){if(!res.ok)throw Error(res.statusText);return res.json()}).then(function(events){for(var i=0;i<events.length;i++){liercd.stream.fire("message",events[i])}}).catch(function(e){liercd.reset()})};liercd.fill_backlog=function(panel,msgid){if(panel.backlog_empty)return;var connection=liercd.connections[panel.connection];if(!connection)return;panel.set_loading(true);var limit=panel.ignore_events?150:50;var name=panel.type=="status"?"status":panel.name;var parts=[liercd.baseurl,"connection",connection.id,"channel",encodeURIComponent(name),"events"];if(msgid)parts.push(msgid);fetch(parts.join("/")+"?limit="+limit,{credentials:"same-origin"}).then(function(res){if(!res.ok)throw Error(res.statusText);return res.json()}).then(function(events){if(events.length<limit)panel.backlog_empty=true;var list=[];var reactions=[];events.forEach(function(e){var message=e.Message;message.Id=e.MessageId;message.Highlight=e.Highlight;if(liercd.is_reaction(message))reactions.push(message);else{var el=Render(message);if(el)list.push(el)}});panel.prepend(list);liercd.filling_backlog=false;reactions.forEach(function(reaction){var parts=reaction.Params[1].split(" ");panel.handle_reaction(reaction.Prefix.Name,parts[1],parts[2])});panel.react_backlog_check();panel.set_loading(false)}).catch(function(e){liercd.filling_backlog=false;panel.set_loading(false);console.log(e)})};liercd.is_reaction=function(message){return message.Command=="PRIVMSG"&&(message.Params[1]||"").substring(0,5)==""+"FACE"};liercd.prev_panel=function(){var items=liercd.elem.nav.querySelectorAll("li");for(var i=items.length-1;i>=0;i--){var item=items[i];if(item.classList.contains("active")&&items[i-1]){var id=items[i-1].getAttribute("data-panel-id");liercd.focus_panel(id);return}}};liercd.prev_unread_panel=function(){var items=liercd.elem.nav.querySelectorAll("li");for(var i=items.length-1;i>=0;i--){var item=items[i];if(item.classList.contains("active")){for(var j=i;j>0;j--){var item=items[j-1];if(item.classList.contains("unread")){var id=item.getAttribute("data-panel-id");liercd.focus_panel(id);return}}return}}};liercd.next_panel=function(){var items=liercd.elem.nav.querySelectorAll("li");for(var i=0;i<items.length;i++){var item=items[i];if(item.classList.contains("active")&&items[i+1]){var id=items[i+1].getAttribute("data-panel-id");liercd.focus_panel(id);return}}};liercd.next_unread_panel=function(){var items=liercd.elem.nav.querySelectorAll("li");for(var i=0;i<items.length;i++){var item=items[i];if(item.classList.contains("active")){for(var j=i;j<items.length;j++){var item=items[j+1];if(item.classList.contains("unread")){var id=item.getAttribute("data-panel-id");liercd.focus_panel(id);return}}return}}};liercd.focus_panel=function(id){if(liercd.focused){if(liercd.focused.id==id)return;liercd.last_panel_id=liercd.focused.id}if(liercd.elem.switcher.classList.contains("open")){liercd.hide_switcher()}var panel=liercd.panels[id];if(!panel)return;liercd.elem.panel_name.textContent=panel.name;liercd.replace_child("panel",panel.elem.list);liercd.replace_child("input",panel.elem.input);liercd.replace_child("topic",panel.elem.topic);liercd.replace_child("filler",panel.elem.filler);liercd.replace_child("prefix",panel.elem.prefix);liercd.elem.body.setAttribute("data-panel-type",panel.type);liercd.replace_child("nicks",panel.elem.nicks);liercd.elem.title.textContent=panel.name;if(liercd.focused){liercd.focused.unfocus();liercd.save_seen(liercd.focused)}if(panel.first_focus&&panel.type=="channel")liercd.show_nicklist_pref(panel);panel.focus();liercd.focused=panel;window.history.replaceState({},"",panel.path);liercd.check_scroll();if(panel.type=="channel"){var conn=liercd.connections[panel.connection];panel.update_nicks(conn.nicks(conn.channel(panel.name)))}};liercd.replace_child=function(p,c){p=liercd.elem[p];while(p.firstChild){p.removeChild(p.firstChild)}p.appendChild(c)};liercd.config_modal=function(e,connection){if(e)e.preventDefault();liercd.elem.flex_wrap.classList.remove("open");var method="POST";var url=liercd.baseurl+"/connection";var overlay=document.createElement("DIV");overlay.classList.add("overlay");var o=document.querySelector(".config").cloneNode(true);overlay.appendChild(o);if(connection){var config=connection.Config;var form=overlay.querySelector("form");form.querySelector('input[name="Host"]').value=config.Host;form.querySelector('input[name="Port"]').value=config.Port;if(config.Ssl)form.querySelector('input[name="Ssl"]').checked="checked";form.querySelector('input[name="Nick"]').value=config.Nick;form.querySelector('input[name="User"]').value=config.User;form.querySelector('input[name="Pass"]').value=config.Pass;form.querySelector('input[name="Channels"]').value=config.Channels.join(", ");if(config.Highlight)form.querySelector('input[name="Highlight"]').value=config.Highlight.join(", ");overlay.querySelector("h2").textContent="Edit connection";var submit=overlay.querySelector('input[type="submit"]');submit.value="Save & Reconnect";submit.fontWeight="bold";var del=document.createElement("INPUT");del.setAttribute("type","submit");del.value=" Delete";del.classList.add("delete-connection");del.addEventListener("click",function(e){e.preventDefault();liercd.delete_connection(connection.Id);overlay.parentNode.removeChild(overlay);liercd.overlayed=false});submit.parentNode.insertBefore(del,submit);url+="/"+connection.Id;method="PUT"}else{var form=overlay.querySelector("form");form.querySelector('input[name="Nick"]').value=liercd.user.user;form.querySelector('input[name="User"]').value=liercd.user.user;form.querySelector('input[name="Highlight"]').value=liercd.user.user;if(Object.keys(liercd.connections).length==0){form.querySelector('input[name="Host"]').value="irc.freenode.com";form.querySelector('input[name="Port"]').value="6697";form.querySelector('input[name="Ssl"]').checked="checked";form.querySelector('input[name="Channels"]').value="#liercd"}}liercd.elem.body.appendChild(overlay);liercd.overlayed=true;["click","touchstart"].forEach(function(type){overlay.addEventListener(type,function(e){if(!e.target.matches(".overlay, .close"))return;e.preventDefault();liercd.overlayed=false;overlay.parentNode.removeChild(overlay)})});overlay.addEventListener("submit",function(e){e.preventDefault();var form=e.target;var data={Host:form.querySelector('input[name="Host"]').value,Port:parseInt(form.querySelector('input[name="Port"]').value),Ssl:form.querySelector('input[name="Ssl"]').checked,Nick:form.querySelector('input[name="Nick"]').value,User:form.querySelector('input[name="User"]').value,Pass:form.querySelector('input[name="Pass"]').value,Channels:form.querySelector('input[name="Channels"]').value.split(/\s*,\s*/),Highlight:form.querySelector('input[name="Highlight"]').value.split(/\s*,\s*/)};fetch(url,{method:method,body:JSON.stringify(data),credentials:"same-origin"}).then(function(res){if(!res.ok)throw Error(res.statusText);return res.json()}).then(function(res){if(method=="DELETE"){for(panel in liercd.panels){if(panel.type=="channel"){liercd.remove_panel(panel.id)}}delete liercd.connections[connection.Id]}overlay.parentNode.removeChild(overlay);liercd.overlayed=false}).catch(function(e){console.log(e);alert("i'm sorry")})})};liercd.check_scroll=function(){if(liercd.filling_backlog||!liercd.focused||liercd.focused.backlog_empty||!liercd.connections[liercd.focused.connection]||getComputedStyle(liercd.elem.scroll).display=="none"){return}if(liercd.elem.scroll.scrollTop<=150){liercd.filling_backlog=true;liercd.fill_backlog(liercd.focused,liercd.focused.oldest_message_id())}};setInterval(liercd.check_scroll,250);liercd.ping_server=function(){fetch(liercd.baseurl+"/auth",{credentials:"same-origin"}).then(function(res){if(res.status==200)return;if(res.status==401){return}console.log(res.status);if(res.status==0){liercd.stream.close();return}var data=res.json();if(data["error"]){console.log(data["error"])}})};setInterval(liercd.ping_server,1e3*15);liercd.get_prefs=function(cb){fetch(liercd.baseurl+"/preference",{credentials:"same-origin"}).then(function(res){if(!res.ok)throw Error(res.statusText);return res.json()}).then(function(data){var prefs={};for(var i=0;i<data.length;i++){try{prefs[data[i].name]=JSON.parse(data[i].value)}catch(e){console.log("Unable to parse JSON: ",data[i].value)}}cb(prefs)}).catch(function(){cb()})};liercd.get_pref=function(name){return liercd.prefs[name]};liercd.show_nicklist_pref=function(panel){var value=liercd.get_pref(panel.id+"-show-nicklist");if(value!=undefined)panel.set_show_nicklist(value)};liercd.ignore_events_pref=function(panel){var value=liercd.get_pref(panel.id+"-ignore-events");if(value!==undefined)panel.set_ignore_events(value)};liercd.collapse_embeds_pref=function(panel){var value=liercd.get_pref(panel.id+"-collapse-embeds");if(value!==undefined)panel.set_collapse_embeds(value)};liercd.monospace_nicks_pref=function(panel){var value=liercd.get_pref(panel.id+"-monospace-nicks");if(value!==undefined)panel.monospace_nicks=value};liercd.add_monospace_nick=function(panel,nick){panel.add_monospace_nick(nick);liercd.update_pref(panel.id+"-monospace-nicks",panel.monospace_nicks)};liercd.remove_monospace_nick=function(panel,nick){panel.remove_monospace_nick(nick);liercd.update_pref(panel.id+"-monospace-nicks",panel.monospace_nicks)};liercd.update_pref=function(name,value){liercd.prefs[name]=value;fetch(liercd.baseurl+"/preference/"+encodeURIComponent(name),{method:"POST",body:JSON.stringify(value),credentials:"same-origin"})};liercd.load_token=function(cb){fetch(liercd.baseurl+"/token",{credentials:"same-origin"}).then(function(res){if(!res.ok)throw Error(res.statusText);return res.json()}).then(function(data){liercd.post_tokens.push(data.token);if(data.extra){liercd.post_tokens=liercd.post_tokens.concat(data.extra)}if(cb)cb()}).catch(function(e){alert("Error fetching token: "+e);if(cb)cb()})};liercd.load_seen=function(cb){fetch(liercd.baseurl+"/seen",{credentials:"same-origin"}).then(function(res){if(!res.ok)throw Error(res.statusText);return res.json()}).then(function(res){for(i in res){var id=panel_id(res[i]["channel"],res[i]["connection"]);liercd.last_seen[id]=res[i]["message_id"]}cb()}).catch(function(e){cb()})};liercd.save_seen=function(panel,force){var diffs=0;var id=panel.id;var last_seen=panel.last_seen;var send=last_seen&&last_seen!=liercd.last_seen[id];if(send||force){var parts=[liercd.baseurl,"connection",panel.connection,"channel",encodeURIComponent(panel.name),"seen"];fetch(parts.join("/"),{credentials:"same-origin",method:"POST",body:""+last_seen});liercd.last_seen[id]=last_seen}};liercd.sync_missed=function(){if(liercd.focused){liercd.focused.update_seen();if(liercd.focused.last_seen)liercd.last_seen[liercd.focused.id]=liercd.focused.last_seen}var query=[];for(k in liercd.last_seen){query.push([encodeURIComponent(k),encodeURIComponent(liercd.last_seen[k])].join("="))}var url=liercd.baseurl+"/missed?"+query.join("&");fetch(url,{credentials:"same-origin"}).then(function(res){if(!res.ok)throw Error(res.statusText);return res.json()}).then(function(res){liercd.missed={};for(connection in res){for(channel in res[connection]){var id=panel_id(channel,connection);if(liercd.panels[id]){liercd.apply_missed(liercd.panels[id],res[connection][channel])}else{liercd.missed[id]=res[connection][channel]}}}}).catch(function(e){console.log(e)})};liercd.search_panel=function(panel,text){var url=liercd.baseurl+"/connection/"+panel.connection+"/channel/"+encodeURIComponent(panel.name)+"/last?"+"query="+encodeURIComponent(text)+"&limit=10";fetch(url,{credentials:"same-origin"}).then(function(res){if(!res.ok)throw Error(res.statusText);return res.json()}).then(function(messages){if(messages.length>0){var line=document.createElement("DIV");line.classList.add("search-start");var scrolled=panel.is_scrolled();panel.elem.list.appendChild(line);if(scrolled)panel.scroll()}for(var i=messages.length-1;i>=0;i--){var msg=messages[i].Message;msg.Search=true;panel.append(Render(msg))}})};liercd.get_prefs(function(prefs){liercd.prefs=prefs;liercd.sorting=liercd.prefs["sorting"]||[];delete liercd.prefs["sorting"];if(liercd.prefs["email"]===true){document.getElementById("email-notify").classList.add("enabled")}liercd.load_seen(function(){liercd.load_token(function(){liercd.init()})})});liercd.update_email_pref=function(disabled){};liercd.focus_input=function(force){if(force){liercd.focused.elem.input.focus();return}if(liercd.mobile)return;if(!liercd.focused)return;if(document.querySelectorAll(".overlay").length)return;liercd.focused.elem.input.focus()};liercd.hide_switcher=function(){liercd.elem.switcher.classList.remove("open");liercd.elem.nav.classList.remove("filtering");liercd.elem.nav.querySelectorAll("li").forEach(function(li){li.classList.remove("match","selected","candidate")})};liercd.toggle_switcher=function(){liercd.elem.switcher.querySelector("input").value="";if(liercd.elem.switcher.classList.contains("open")){liercd.hide_switcher()}else{liercd.elem.switcher.classList.add("open");liercd.elem.nav.classList.add("filtering");liercd.elem.nav.querySelectorAll("#channels li[data-name], #privates li[data-name]").forEach(function(li){li.classList.add("candidate","match")});var matches=liercd.elem.nav.querySelectorAll("li[data-name].candidate");if(matches.length){matches[0].classList.add("selected")}liercd.elem.switcher.querySelector("input").focus()}};liercd.save_channel_order=function(){var order=Array.prototype.map.call(liercd.elem.channels.querySelectorAll("li"),function(li){return li.getAttribute("data-panel-id")});liercd.sorting=order;liercd.update_pref("sorting",order)};liercd.reset=function(){var path=liercd.focused?liercd.focused.path:"";for(id in liercd.panels){liercd.remove_panel(id)}window.history.replaceState({},"",path);liercd.default_focused=false;liercd.connections=[];liercd.last_seen={};liercd.missed={};liercd.focused=null;liercd.load_seen(function(){liercd.load_token(function(){liercd.init()})})};function detect_mobile(){return function(a){if(/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows ce|xda|xiino/i.test(a)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(a.substr(0,4)))return true;return false}(navigator.userAgent||navigator.vendor||window.opera)}var events=new UIEvents(liercd)};var Embed={patterns:[]};var embed_id=0;Embed.embed_all=function(els,panel){els.forEach(function(el){el.querySelectorAll(".message-text a[href]").forEach(function(link){Embed.embed(link,panel)})})};Embed.embed=function(a,panel){var href=a.href;var id=embed_id++;for(var i=0;i<Embed.patterns.length;i++){if(Embed.patterns[i].test(href)){var url="//noembed.com/embed?url="+encodeURIComponent(href)+"&maxwidth=450";fetch(url).then(function(res){if(!res.ok)throw Error(res.statusText);return res.json()}).then(function(res){if(!res.error){panel.scroll(function(){var toggle=document.createElement("SPAN");res["id"]=id;toggle.setAttribute("data-embed",JSON.stringify(res));toggle.setAttribute("data-embed-id",id);toggle.setAttribute("class","embed-toggle");toggle.setAttribute("aria-hidden","true");a.parentNode.insertBefore(toggle,a.nextSibling);panel.embed(a,res)})}});return}}};Embed.load=function(){fetch("//noembed.com/providers").then(function(res){if(!res.ok)throw Error(res.statusText);return res.json()}).then(function(res){for(provider in res){var p=res[provider].patterns;for(var i=0;i<p.length;i++){Embed.patterns.push(new RegExp(p[i]))}}})};Embed.load();var Completion=function(element){var TAB=9;this.completions=[];this.completing=false;this.matches=[];this.position=0;this.index=0;this.el=element;this.complete=function(e){if(!this.completing)this.start();this.cycle()};this.stop=function(){this.completing=false;this.matches=[];this.position=0;this.index=0};this.start=function(){var word=this.last_word();var sel=window.getSelection();this.position=sel.focusOffset-word.length;this.completing=true;this.matches=this.find_matches(word).concat([word]);this.index=0};this.cycle=function(){if(this.index>=this.matches.length)this.index=0;var sel=window.getSelection();var node=sel.focusNode;var start=node.textContent.substring(0,this.position);var end=this.matches[this.index++];if(this.index!=this.matches.length){if(start.indexOf(" ")==-1){end+=":"}end+=" "}node.textContent=start+end;this.move_cursor()};this.move_cursor=function(){var sel=window.getSelection();var node=sel.focusNode;if(node.nodeType==1){if(node.childNodes[0].nodeType==3)node=node.childNodes[0];else return}var length=node.textContent.length;var range=document.createRange();range.setStart(node,length);range.setEnd(node,length);var sel=window.getSelection();sel.removeAllRanges();sel.addRange(range)};this.find_matches=function(word){word=word.toLowerCase();var matches=[];var length=word.length;for(var i=0;i<this.completions.length;i++){var w=this.completions[i];if(w.length<length)continue;if(w.substring(0,length).toLowerCase()==word)matches.push(w)}return matches};this.last_word=function(){var sel=window.getSelection();var node=sel.focusNode;return node.textContent.replace(/.*\s/,"")}};
//# sourceMappingURL=/static/site.map.js